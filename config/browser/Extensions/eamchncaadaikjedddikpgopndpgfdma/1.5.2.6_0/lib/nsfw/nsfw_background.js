!function(r){let o=!1;const d=t=>({tabId:t.id||999,tabUrl:t.url||"999"});function i(){r.nsfwEnv}function t(){this.IMAGE_SIZE=224,this.channel=0,this.cache=new LRUMap(100),this.requestMap=new Map,this.loadingMap=new Map,this.tabMap=new Map,this.activeTab="",this.tasks=[]}function a(){var t,e,s,a;r.nsfwQueue.model||!r.settings.isFilteringDisabled()&&r.settings.getProperty(r.settings.DISABLE_ALLOW_PROTECT_BAD_CONTENT)&&(t="tflite/tflite.js",e=function(){nsfw_controller.load().then(t=>{r.nsfwQueue.init(t)}).catch(t=>{o=!0})},s=document.createElement("script"),a=e||function(){},s.type="text/javascript",s.onload=function(){a()},s.src=t,document.getElementsByTagName("head")[0].appendChild(s))}r.nsfwEnv="dev",t.prototype.addTabIdUrl=function(t){this.tabMap.set(t.tabId,t)},t.prototype.clearByTabId=function(t){this.tabMap.delete(t)},t.prototype.updateTabIdUrl=function(t){this.tabMap.set(t.tabId,t)},t.prototype.setActiveTabId=function(t){this.activeTab=t,this.tabMap.has(t.tabId)||this.tabMap.set(t.tabId,t)},t.prototype.start=function(){this.requestMap.forEach((t,e)=>{var[{tab:s,resolve:a,reject:i,dom_type:n}]=t;100<this.channel?setTimeout(()=>{this.start()},1e3):(this.requestMap.delete(e),this.activeTab.tabId!=s.tabId&&this.tabMap.has(s.tabId)?this.loadingMap.set(e,t):(this.tasks.push({url:e,resolve:a,reject:i,dom_type:n,tab:s}),this.channel++))}),this.channel<100&&this.loadingMap.forEach((t,e)=>{var[{tab:s,resolve:a,reject:i,dom_type:t}]=t;this.tabMap.has(s.tabId)?100<this.channel||(this.tasks.push({url:e,resolve:a,reject:i,dom_type:t,tab:s}),this.loadingMap.delete(e),this.channel++):this.loadingMap.delete(e)});let i=this.tasks.shift();i?(this.channel--,this.loadimg(i.url).then(t=>{(new Date).getTime();this.model.classify(t).then(t=>{let e={result:!1,url:i.url};var s="video"==i.dom_type?r.uos.pornRuleCfg.videoCriteriaPer:r.uos.pornRuleCfg.imgCriteriaPer,a="video"==i.dom_type?r.uos.pornRuleCfg.sexyVideoCriteriaPer:r.uos.pornRuleCfg.sexyImgCriteriaPer;(100*t.Porn>=s||100*t.Hentai>=s||100*t.Sexy>=a)&&(e.result=!0),i.resolve(e),e.result&&r.listeners.notifyListeners(r.listeners.ADS_BLOCKED,{filterId:r.pageStats.NSFW_PROTOTYPE_NAME,filterType:i.dom_type},i.tab,1),/^data:/.test(i.url)||this.cache.set(i.url,e),this.start()}).catch(t=>{i.reject({url:i.url,err:t}),this.start()})}).catch(t=>{i.reject({url:i.url,err:t}),this.start()})):setTimeout(()=>{this.start()},500)},t.prototype.loadimg=function(s){let a=new Image(this.IMAGE_SIZE,this.IMAGE_SIZE);return new Promise((t,e)=>{if(/^data:/.test(s))return a.src=s,i(),void t(a);a.crossOrigin="anonymous",a.onload=()=>t(a),a.onerror=t=>e(t),a.src=s})},t.prototype.init=function(t){this.model=t,this.start()},t.prototype.addTask=function(t){var{message:e,sender:t}=t;const{url:a,dom_type:i}=e,n=d(t.tab);return new Promise((t,e)=>{if(o&&e({url:a}),this.cache.has(a)){var s=this.cache.get(a);return s.result&&r.listeners.notifyListeners(r.listeners.ADS_BLOCKED,{filterId:r.pageStats.NSFW_PROTOTYPE_NAME,filterType:i},n,1),void t(s)}if(this.activeTab.tabId!=n.tabId&&this.tabMap.has(n.tabId))return"video"==i?void 0:void this.loadingMap.set(a,[{resolve:t,reject:e,tab:n,dom_type:i}]);this.requestMap.set(a,[{resolve:t,reject:e,tab:n,dom_type:i}])})},r.nsfwQueue=new t,setTimeout(a,500),r.uos.event.addEventListener("nsfw_need_init",a),chrome.runtime.onMessage.addListener((e,t,s)=>{return"nsfw"===e.type&&(i(e.url),r.nsfwQueue.addTask({message:e,sender:t}).then(t=>{s(t)}).catch(t=>{s({...e,err:t})})),"changeApplicationFilteringDisabled"===e.type&&a(),"changeUserSetting"===e.type&&a(),"nsfw_conf"===e.type&&(t=r.uos.getPornRuleCfg(t.url),s(t)),!0}),chrome.tabs.onCreated.addListener(function(t){t=d(t);r.nsfwQueue.addTabIdUrl(t)}),chrome.tabs.onRemoved.addListener(function(t){r.nsfwQueue.clearByTabId(t)}),chrome.tabs.onUpdated.addListener(function(t,e,s){"loading"===e.status&&(s=d(s),r.nsfwQueue.updateTabIdUrl(s))}),chrome.tabs.onActivated.addListener(function(t){r.nsfwQueue.setActiveTabId(t)}),chrome.runtime.onConnect.addListener(()=>{})}(adguard);