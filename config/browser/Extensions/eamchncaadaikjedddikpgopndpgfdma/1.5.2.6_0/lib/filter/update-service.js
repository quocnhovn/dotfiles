adguard.applicationUpdateService=function(l){const o={LINE_BREAK:"\n",FILE_PATH:"filters.ini",readFromFile(e,t){this._getFile(e,!0,function(e,r){r.file(e=>{const r=new FileReader;r.onloadend=function(){if(r.error)t(r.error);else{let e=[];r.result&&(e=r.result.split(/[\r\n]+/)),t(null,e)}},r.onerror=function(e){t(e)},r.readAsText(e)},t)},t)},_getFile(e,t,s,o){e=e.replace(/^.*[\/\\]/,"");const r=window.requestFileSystem||window.webkitRequestFileSystem;r(window.PERSISTENT,1073741824,r=>{r.root.getFile(e,{create:t},e=>{s(r,e)},o)},o)},removeFile(e,t,s){this._getFile(e,!1,(e,r)=>{r.remove(t,s)},s)}};function i(){l.console.info("Call update to version 2.3.5");const e=new l.utils.Promise,t=l.utils.filters.USER_FILTER_ID,s=`filterrules_${t}.txt`;return o.readFromFile(s,(e,r)=>{e?l.console.error("Error while reading rules from file {0} cause: {1}",s,e):(r&&l.console.info("Found rules:"+r.length),l.rulesStorage.write(t,r,function(){l.console.info("Rules have been transferred to local storage for filter {0}",t),o.removeFile(s,()=>{l.console.info("File removed for filter {0}",t)},()=>{l.console.error("File remove error for filter {0}",t)})}))}),e.resolve(),e}function n(){const n=new l.utils.Promise;function e(){l.console.info("Call update to use indexedDB instead of storage.local for Firefox browser"),browser.storage.local.get(null,e=>{const r=[];for(const t in e)e.hasOwnProperty(t)&&0===t.indexOf("filterrules_")&&r.push(t);!function e(r,t){if(0===r.length)n.resolve();else{const o=r.shift();var s=t[o]||[];const i=s.length;l.rulesStorageImpl.write(o,s,()=>{l.console.info('Adguard filter "{0}" has been migrated. Rules: {1}',o,i),browser.storage.local.remove(o),e(r,t)})}}(r,e)})}return l.rulesStorageImpl.isIndexedDB?e():n.resolve(),n}function u(){const e=new l.utils.Promise,o="edge-storage-local-fix-build"+l.utils.browser.EDGE_CREATORS_UPDATE;if(l.localStorage.getItem(o))return e.resolve(),e;l.console.info("Call update to use storage.local for Edge browser");const i=[];for(const r in localStorage)localStorage.hasOwnProperty(r)&&0===r.indexOf("filterrules_")&&i.push(r);return function r(){if(0===i.length)l.localStorage.setItem(o,!0),e.resolve();else{const t=i.shift();let e=[];const s=localStorage.getItem(t);s&&(e=s.split(/[\r\n]+/)),l.rulesStorageImpl.write(t,e,()=>{localStorage.removeItem(t),r()})}}(),e}function a(){const e=new l.utils.Promise,r=l.subscriptions.getFilters(),t=l.filtersState.getFiltersState(),s=r.filter(e=>{e=e.filterId;return!(!t[e]||!t[e].enabled)}),o=l.filtersState.getGroupsState();return s.forEach(e=>{var r=e["groupId"];void 0===o[r]&&l.filters.enableGroup(e.groupId)}),e.resolve(),e}function f(){const e=new l.utils.Promise;return 1728e5===l.settings.getFiltersUpdatePeriod()&&l.settings.setFiltersUpdatePeriod(l.settings.DEFAULT_FILTERS_UPDATE_PERIOD),e.resolve(),e}function c(){const e=new l.utils.Promise;var r=l.settings.getProperty(l.settings.DISABLE_STEALTH_MODE),t=l.settings.getProperty(l.settings.STRIP_TRACKING_PARAMETERS);return!r&&t&&l.filters.addAndEnableFilters([l.utils.filters.ids.URL_TRACKING_FILTER_ID]),e.resolve(),e}function d(){const e=new l.utils.Promise;var r=l.filtersState.getFiltersState();const t=l.subscriptions.getFilters(),s=Object.keys(r).map(e=>Number.parseInt(e,10)),o=s.filter(r=>t.find(e=>e.filterId===r)),i=s.filter(e=>!o.includes(e));i.forEach(e=>l.filtersState.removeFilter(e));r=i.map(r=>new Promise(e=>{l.rulesStorage.remove(r,()=>{l.console.info(`Filter with id: ${r} removed from the storage`),e()}),e()}));return Promise.all(r).then(()=>{e.resolve()}),e}return{getRunInfo:function(e){var r=l.utils.browser.getAppVersion(),t=l.app.getVersion();l.utils.browser.setAppVersion(t),e({isFirstRun:t!==r&&!r,isUpdate:!(t===r||!r),currentVersion:t,prevVersion:r})},onUpdate:function(e,r){const t=[];l.utils.browser.isGreaterVersion("2.3.5",e.prevVersion)&&l.utils.browser.isChromium()&&t.push(i),l.utils.browser.isEdgeBrowser()&&!l.utils.browser.isEdgeBeforeCreatorsUpdate()&&t.push(u),l.utils.browser.isGreaterVersion("2.7.4",e.prevVersion)&&l.utils.browser.isFirefoxBrowser()&&"undefined"!=typeof browser&&t.push(n),l.utils.browser.isGreaterVersion("3.0.3",e.prevVersion)&&t.push(a),l.utils.browser.isGreaterVersion("3.3.5",e.prevVersion)&&t.push(f),l.utils.browser.isGreaterVersion("3.6.0",e.prevVersion)&&t.push(c),t.push(d);const s=function(t){const s=new l.utils.Promise;function o(){if(0===t.length)s.resolve();else{const e=t.shift(),r=e();r.then(o)}}return o(),s}(t);s.then(r)}}}(adguard);