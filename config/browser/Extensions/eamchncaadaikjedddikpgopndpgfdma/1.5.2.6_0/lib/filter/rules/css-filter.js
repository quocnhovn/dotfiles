!function(n,o){"use strict";function s(e){if(this.commonCss=null,this.commonCssHits=null,this.commonRules=[],this.domainSensitiveRules=[],this.extendedCssRules=[],this.exceptionRules=[],this.dirty=!1,e)for(let s=0;s<e.length;s+=1)this.addRule(e[s])}s.RETRIEVE_TRADITIONAL_CSS=1,s.RETRIEVE_EXTCSS=2,s.GENERIC_HIDE_APPLIED=4,s.CSS_INJECTION_ONLY=8;s.prototype={addRule(s){(s.whiteListRule?this.exceptionRules:s.extendedCss?this.extendedCssRules:s.isDomainSensitive()?this.domainSensitiveRules:this.commonRules).push(s),this.dirty=!0},removeRule(s){const e=s["ruleText"];this.exceptionRules=this.exceptionRules.filter(s=>s.ruleText!==e),this.extendedCssRules=this.extendedCssRules.filter(s=>s.ruleText!==e),this.domainSensitiveRules=this.domainSensitiveRules.filter(s=>s.ruleText!==e),this.commonRules=this.commonRules.filter(s=>s.ruleText!==e),this._rollbackExceptionRule(s),this.dirty=!0},getRules(){return[].concat(this.commonRules).concat(this.domainSensitiveRules).concat(this.exceptionRules).concat(this.extendedCssRules)},buildCss(s,e){var t=8==(8&(e=void 0===e?3:e)),i=4==(4&e),l=1==(1&e);t?this._rebuildBinding():this._rebuild();e=this._filterRules(s,e),e=this._createCssStylesheets(e);return!i&&l&&(t=this._getCommonCss(t),Array.prototype.unshift.apply(e.css,t)),e},buildCssHits(s,e){this._rebuildHits();var t=this._filterRules(s,e=void 0===e?3:e),s=4==(4&e),e=1==(1&e);const i=this._createCssStylesheetsHits(t);return!s&&e&&(i.css=this._getCommonCssHits().concat(i.css)),i},_filterRules(e,s){let t=[];var i=2==(2&s);const l=4==(4&s),n=8==(8&s);return e&&(1==(1&s)&&null!==this.domainSensitiveRules&&(s=this.domainSensitiveRules.filter(s=>!!s.isPermitted(e)&&((!l||!s.isGeneric())&&!(n&&!s.isInjectRule))),t=t.concat(s)),i&&null!==this.extendedCssRules&&(i=this.extendedCssRules.filter(s=>!!s.isPermitted(e)&&(!l||!s.isGeneric())),t=t.concat(i))),t},_createCssStylesheets(s){var e=s.filter(s=>s.extendedCss),s=s.filter(s=>!s.extendedCss);return{css:this._buildCssByRules(s),extendedCss:this._buildCssByRules(e)}},_createCssStylesheetsHits(s){var e=s.filter(s=>s.extendedCss),s=s.filter(s=>!s.extendedCss);return{css:this._buildCssByRulesHits(s),extendedCss:this._buildCssByRulesHits(e)}},_rebuild(){this.dirty&&(this._applyExceptionRules(),this.commonCss=this._buildCssByRules(this.commonRules),this.commonCssHits=null,this.dirty=!1)},_rebuildHits(){this.dirty&&(this._applyExceptionRules(),this.commonCssHits=this._buildCssByRulesHits(this.commonRules),this.commonCss=null,this.dirty=!1)},_rebuildBinding(){this.dirty&&(this._applyExceptionRules(),this.commonCss=null,this.commonCssHits=null,this.dirty=!1)},applyExceptionsToRules(e,t){const i=[];for(let s=0;s<e.length;s+=1){var l=e[s],n=t[l.cssSelector];if(n){let e=l;for(let s=0;s<n.length&&(e=this._applyExceptionRule(e,n[s]),e);s+=1);e&&i.push(e)}else i.push(l)}return i},_applyExceptionRules(){var e=this._arrayToMap(this.exceptionRules,"cssSelector");this.domainSensitiveRules=this.applyExceptionsToRules(this.domainSensitiveRules,e),this.extendedCssRules=this.applyExceptionsToRules(this.extendedCssRules,e);const t=[];for(let s=0;s<this.commonRules.length;s+=1){var i=this.commonRules[s],l=e[i.cssSelector];if(l){let e=i;for(let s=0;s<l.length&&(e=this._applyExceptionRule(e,l[s]),e);s+=1);e?(this.commonRules.splice(s,1,e),e.isDomainSensitive()&&t.push(e)):this.commonRules.splice(s,1)}}const n=this._arrayToMap(t,"ruleText");this.domainSensitiveRules=this.domainSensitiveRules.concat(t),this.commonRules=this.commonRules.filter(s=>!(s.ruleText in n))},_applyExceptionRule(s,e){if(s.cssSelector!==e.cssSelector)return s;if(e.isGeneric())return null;e=e.getPermittedDomains();return e&&0<e.length&&s.addRestrictedDomains(e),s},_getCommonCss(s=!1){if(s){s=this.commonRules.filter(s=>s.isInjectRule);return this._buildCssByRules(s)}return null!==this.commonCss&&0!==this.commonCss.length||(this.commonCss=this._buildCssByRules(this.commonRules)),this.commonCss},_getCommonCssHits(){return null!==this.commonCssHits&&0!==this.commonCssHits.length||(this.commonCssHits=this._buildCssByRulesHits(this.commonRules)),this.commonCssHits},_rollbackExceptionRule(t){if(t.whiteListRule){const i=[];let s,e;for(s=0;s<this.domainSensitiveRules.length;s+=1)e=this.domainSensitiveRules[s],e.cssSelector===t.cssSelector&&(e.removeRestrictedDomains(t.getPermittedDomains()),e.isDomainSensitive()||i.push(e));for(s=0;s<this.extendedCssRules.length;s+=1)e=this.extendedCssRules[s],e.cssSelector===t.cssSelector&&e.removeRestrictedDomains(t.getPermittedDomains());this.commonRules=this.commonRules.concat(i);const l=this._arrayToMap(i,"ruleText");this.domainSensitiveRules=this.domainSensitiveRules.filter(s=>!(s.ruleText in l))}},_buildCssByRules(e){var t=" { display: none!important; }\r\n";let i=0;const l=[],n=[];for(let s=0;s<e.length;s+=1){var o=e[s];o.isInjectRule?n.push(this._getRuleCssSelector(o)):(l.push(this._getRuleCssSelector(o)),++i,i%50==0||o.extendedCss?l.push(t):l.push(", "))}0<l.length&&(l[l.length-1]=t);const s=[];var u=l.join(""),r=n.join("\r\n");return u&&s.push(u),r&&s.push(r),s},_addMarkerToInjectRule(s){var e=encodeURIComponent(";");const t=[],i=this._getRuleCssSelector(s);if(/[{;"(]\s*content\s*:/gi.test(i))return i;var l=i.slice(0,-1).trim(),l=n.utils.strings.endsWith(l,";")?l:l+";";return t.push(l),t.push(" content: 'adguard"),t.push(s.filterId),t.push(e),t.push(o.FilterRule.escapeRule(s.ruleText)),t.push("' !important;}\r\n"),t.join("")},_addMarkerToElemhideRule(s){var e=encodeURIComponent(";");const t=[];return t.push(this._getRuleCssSelector(s)),t.push(" { display: none!important; content: 'adguard"),t.push(s.filterId),t.push(e),t.push(o.FilterRule.escapeRule(s.ruleText)),t.push("' !important;}\r\n"),t.join("")},_buildCssByRulesHits(e){const t=[];for(let s=0;s<e.length;s+=1){var i=e[s];i.isInjectRule?t.push(this._addMarkerToInjectRule(i)):t.push(this._addMarkerToElemhideRule(i))}return t},_getRuleCssSelector(s){return s.cssSelector},_arrayToMap(e,t){const i=Object.create(null);for(let s=0;s<e.length;s+=1){var l=e[s],n=l[t];n in i||(i[n]=[]),i[n].push(l)}return i}},o.CssFilter=s}(adguard,adguard.rules);