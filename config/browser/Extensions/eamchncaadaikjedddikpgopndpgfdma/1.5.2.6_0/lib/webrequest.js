!function(c){"use strict";const p="Content-Security-Policy",m={[c.RequestTypes.SUBDOCUMENT]:["frame","iframe"],[c.RequestTypes.IMAGE]:["img"]},q=c.prefs.features.canUseInsertCSSAndExecuteScript;function f(e){return e.referrerUrl||c.frames.getFrameUrl(e.tab,e.requestFrameId)||c.frames.getMainFrameUrl(e.tab)}c.webRequest.onBeforeRequest.addListener(function(r){if(!c.app.isOwnRequest(r.referrerUrl)){var{tab:s,requestId:a,originUrl:n,requestType:i,frameId:e,requestFrameId:o=0,method:u}=r,d=s["tabId"];let t=r["requestUrl"];if(i!==c.RequestTypes.DOCUMENT&&i!==c.RequestTypes.SUBDOCUMENT||c.frames.recordFrame(s,e,t,i),i===c.RequestTypes.DOCUMENT){c.listeners.notifyListeners(c.listeners.UPDATE_TAB_BUTTON_STATE,s,!0),c.requestContextStorage.record(a,t,t,n,i,s);const l=c.webRequestService.removeParamsFromUrl(a);if(l)return{redirectUrl:l};e=c.frames.getFrameWhiteListRule(s);e&&c.requestContextStorage.update(a,{requestRule:e})}if(c.utils.url.isHttpOrWsRequest(t)){r=f(r);16384<t.length&&(t=t.slice(0,16384)),c.requestContextStorage.record(a,t,r,n,i,s);const l=c.webRequestService.removeParamsFromUrl(a,u);if(l)return{redirectUrl:l};let e=c.webRequestService.getRuleForRequest(s,t,r,i);e=c.webRequestService.postProcessRequest(s,t,r,i,e),e&&c.requestContextStorage.update(a,{requestRule:e});a=c.webRequestService.getBlockedResponseByRule(e,i,t);if(e&&!e.whiteListRule&&e.isBlockPopups()&&i===c.RequestTypes.DOCUMENT)if(c.tabs.isNewPopupTab(d))return c.tabs.remove(d),{cancel:!0};return a&&a.documentBlockedPage?(c.rules.documentFilterService.showDocumentBlockPage(d,a.documentBlockedPage),{cancel:!0}):(a&&a.cancel&&function(s,a,n,i,e){if(q){var o=m[e];if(o&&-1!==s){i=c.utils.url.isThirdPartyRequest(n,i);let e=n.indexOf("//");i||(e=n.indexOf("/",e+2));var u=n.substring(e);let t="",r=o.length;for(;r--;)t+=o[r]+`[src$="${u}"] { display: none!important; visibility: hidden!important; height: 0px!important; min-height: 0px!important; }
`;c.tabs.insertCssCode(s,a,t)}}}(d,o,t,r,i),a)}}},["<all_urls>"]),c.webRequest.onBeforeRequest.addListener(function(t){var{requestBody:e,requestUrl:r,originUrl:s,requestId:a,referrerUrl:n,requestType:i,tab:o}=t;if(c.requestContextStorage.get(a)||c.requestContextStorage.record(a,r,n,s,i,o),c.utils.url.isThirdPartyRequest(r,s))return c.requestContextStorage.update(a,{cspReportBlocked:!0}),{cancel:!0};if(c.utils.browser.isFirefoxBrowser())try{var u=c.app.getExtensionUrl();const d=String.fromCharCode.apply(null,new Uint8Array(e.raw[0].bytes));if(-1!==d.indexOf(u))return c.requestContextStorage.update(a,{cspReportBlocked:!0}),{cancel:!0}}catch(e){c.console.debug("Unable to parse CSP report request body content",t.url)}},["<all_urls>"],["csp_report"],["requestBody"]),c.webRequest.onBeforeSendHeaders.addListener(function(e){var{tab:t,requestId:r,requestType:s,requestHeaders:e}=e;c.requestContextStorage.update(r,{requestHeaders:e});let a=!1;return s!==c.RequestTypes.DOCUMENT||(s=c.utils.browser.findHeaderByName(e,"Referer"))&&c.frames.recordFrameReferrerHeader(t,s.value),c.cookieFiltering.filterRequestHeaders(r,e)&&(a=!0),c.stealthService.processRequestHeaders(r,e)&&(a=!0),a?(c.requestContextStorage.update(r,{modifiedRequestHeaders:e}),{requestHeaders:e}):{}},["<all_urls>"]),c.webRequest.onHeadersReceived.addListener(function(e){var t=e["tab"],r=e["requestUrl"];let s=e.responseHeaders||[];var a,n=e["requestType"],i=f(e),o=e["requestId"],u=e["statusCode"],d=e["method"];c.requestContextStorage.update(o,{responseHeaders:s}),c.webRequestService.processRequestResponse(t,r,i,n,s),n===c.RequestTypes.DOCUMENT&&301!==u&&302!==u&&function(t,e){if(!c.frames.isTabProtectionDisabled(t)&&!c.frames.isTabWhiteListedForSafebrowsing(t)){var r=c.utils.browser.getSafebrowsingBackUrl(t);const s=c.frames.isIncognitoTab(t);c.safebrowsing.checkSafebrowsingFilter(e,r,e=>{s?c.ui.openTab(e,{},()=>{c.tabs.remove(t.tabId)}):c.tabs.reload(t.tabId,e)})}}(t,r),c.contentFiltering&&(a=c.utils.browser.getHeaderValueByName(s,"content-type"),c.contentFiltering.apply(t,r,i,n,o,u,d,a));let l=!1;if(n!==c.RequestTypes.DOCUMENT&&n!==c.RequestTypes.SUBDOCUMENT||(e=function(e){if(!c.utils.browser.isEdgeBeforeCreatorsUpdate()){var t=e["tab"],r=e["requestId"],s=e["requestUrl"],a=e["requestType"],e=c.frames.getFrameUrl(t,e.frameId);const o=[];var n=c.webRequestService.getCspRules(t,s,e,a);if(n){for(let e=0;e<n.length;e+=1){var i=n[e];c.webRequestService.isRequestBlockedByRule(i)&&o.push({name:p,value:i.cspDirective})}0<n.length&&c.requestContextStorage.update(r,{cspRules:n})}return o}}(e))&&0<e.length&&(s=s.concat(e),l=!0),c.cookieFiltering.filterResponseHeaders(o,s)&&(l=!0),l)return c.requestContextStorage.update(o,{modifiedResponseHeaders:s}),{responseHeaders:s}},["<all_urls>"]);c.webNavigation.onCommitted.addListener(e=>{var{tab:t,requestType:r,frameId:s,requestUrl:e}=e;r===c.RequestTypes.DOCUMENT&&t.tabId!==c.BACKGROUND_TAB_ID&&c.frames.checkAndRecordMainFrame(t,s,e,r)});let t=null;c.listeners.addListener(e=>{switch(e){case c.listeners.ADD_RULES:case c.listeners.REMOVE_RULE:case c.listeners.UPDATE_FILTER_RULES:case c.listeners.UPDATE_WHITELIST_FILTER_RULES:case c.listeners.FILTER_ENABLE_DISABLE:null!==t&&clearTimeout(t),t=setTimeout(()=>{t=null,c.webRequest.handlerBehaviorChanged()},3e3)}}),q&&function(u){const d={set(e,t,r){0===t&&delete this[e],this[e]||(this[e]={}),this[e][t]=r},get(e,t){if(this[e])return this[e][t]},removeTabFrameInjection(e,t){this[e]&&(delete this[e][t],0===Object.keys(this[e]).length&&delete this[e])},removeTabInjection(e){delete this[e]}},t=/["'\\\n\r\u2028\u2029]/g;function r(e){switch(e){case'"':case"'":case"\\":return"\\"+e;case"\n":return"\\n\\\n";case"\r":return"";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029"}}const s="scriptExecuted"+Date.now();function i(e){return e?`(function() {                    if (window.${s}) {                        return;                    }                    var script = document.createElement("script");                    script.setAttribute("type", "text/javascript");                    script.textContent = "${e.replace(t,r)}";                    var FRAME_REQUESTS_LIMIT = 500;                    var frameRequests = 0;                    function waitParent () {                        frameRequests += 1;                        var parent = document.head || document.documentElement;                        if (parent) {                            try {                                parent.appendChild(script);                                parent.removeChild(script);                            } catch (e) {                            } finally {                                window.${s} = true;                                return true;                            }                        }                        if(frameRequests < FRAME_REQUESTS_LIMIT) {                            requestAnimationFrame(waitParent);                        } else {                            console.log("AdGuard: document.head or document.documentElement were unavailable too long");                        }                    }                    waitParent();                })()`:null}function o(e){return e&&e.css?e.css.join("\n"):null}function l(e,t,r){return"onCompleted"===r&&e===u.RequestTypes.DOCUMENT||(t===u.BACKGROUND_TAB_ID||e!==u.RequestTypes.DOCUMENT&&e!==u.RequestTypes.SUBDOCUMENT)}function c(e){var t=e["requestType"],r=e["tab"],s=r["tabId"];l(t,s)||(r=e["frameId"],t=e.requestUrl,e=u.rules.CssFilter.RETRIEVE_TRADITIONAL_CSS,!1===(e=u.webRequestService.processGetSelectorsAndScripts({tabId:s},t,e,!0)).requestFilterReady?d.set(s,r,{ready:!1}):d.set(s,r,{ready:!0,jsScriptText:i(e.scripts),cssText:o(e.selectors),url:t}))}function p(e,t){var r=e["tab"],s=r["tabId"],a=e["frameId"],n=e["requestType"],i=e.requestUrl;if(!l(n,s,t)){var o=d.get(s,a);return o&&!o.ready?(setTimeout((e,t)=>{c(e),p(e,t)},100,e,t),void d.removeTabFrameInjection(s,a)):n!==u.RequestTypes.DOCUMENT||o&&(r=i,(n=o)&&n.url===r)?void(o&&(o.jsScriptText&&u.tabs.executeScriptCode(s,a,o.jsScriptText),o.cssText&&u.tabs.insertCssCode(s,a,o.cssText),m(i,a,u.frames.getMainFrameUrl({tabId:s}))&&u.console.warn("Unexpected onCommitted event from this frame - frameId: {0}, frameUrl: {1}. See https://github.com/AdguardTeam/AdguardBrowserExtension/issues/1046",a,i),d.removeTabFrameInjection(s,a))):(c(e),void p(e,t))}}function m(e,t,r){return(e===r||"about:blank"===e||"about:srcdoc"===e||-1<e.indexOf("javascript:"))&&t!==u.MAIN_FRAME_ID}u.webRequest.onHeadersReceived.addListener(c,["<all_urls>"]),u.webRequest.onResponseStarted.addListener(function(e){var{tab:t,requestType:r,frameId:e}=e,t=t["tabId"];l(r,t)||(r=d.get(t,e))&&r.jsScriptText&&u.tabs.executeScriptCode(t,e,r.jsScriptText)},["<all_urls>"]),u.webNavigation.onCommitted.addListener(p),u.webRequest.onErrorOccurred.addListener(function(e){var t=e["requestType"],r=(r=e["tab"])["tabId"];l(t,r)||(e=e["frameId"],d.removeTabFrameInjection(r,e))},["<all_urls>"]),u.webNavigation.onDOMContentLoaded.addListener(function t(e){var{frameId:r,tabId:s,url:a}=e,n=u.frames.getMainFrameUrl({tabId:s});n&&m(a,r,n)&&(a=u.rules.CssFilter.RETRIEVE_TRADITIONAL_CSS,!1!==(n=u.webRequestService.processGetSelectorsAndScripts({tabId:s},n,a,!0)).requestFilterReady?(a=i(n.scripts),n=o(n.selectors),a&&u.tabs.executeScriptCode(s,r,a),n&&u.tabs.insertCssCode(s,r,n)):setTimeout(e=>{t(e)},100,e))}),u.utils.browser.isFirefoxBrowser()&&u.webRequest.onCompleted.addListener(e=>{p(e,"onCompleted")},["<all_urls>"]),u.tabs.onRemoved.addListener(d.removeTabInjection)}(c),c.webRequest.onCompleted.addListener(({requestId:e})=>{c.cookieFiltering.modifyCookies(e),c.requestContextStorage.onRequestCompleted(e)},["<all_urls>"]),c.webRequest.onErrorOccurred.addListener(({requestId:e})=>{c.cookieFiltering.modifyCookies(e),c.requestContextStorage.onRequestCompleted(e)},["<all_urls>"]),c.webRequest.onBeforeRedirect.addListener(({requestId:e,redirectUrl:t})=>{t&&0===t.indexOf("data:")&&c.requestContextStorage.onRequestCompleted(e)},["<all_urls>"]),c.webNavigation.onCommitted.addListener(e=>{var{tab:t,requestType:r,frameId:e}=e;r!==c.RequestTypes.DOCUMENT&&r!==c.RequestTypes.SUBDOCUMENT||t.tabId===c.BACKGROUND_TAB_ID||c.tabs.executeScriptFile(t.tabId,{file:"/lib/content-script/subscribe.js",frameId:e})})}(adguard);