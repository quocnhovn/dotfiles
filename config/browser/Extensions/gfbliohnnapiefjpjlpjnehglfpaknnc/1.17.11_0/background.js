(()=>{"use strict";function e(e,t){chrome.storage.local.get(["logLevels"],(n=>{const o=n&&n.logLevels||["error"];-1!==["log","warn","error"].indexOf(e)&&-1!==o.indexOf(e)&&console[e](t)}))}function t(e,t,n){if(t&&t.length){var o=function(e,t,n){var o=null;const r=t?"":"i";if(e=e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&"),n)o=new RegExp(e.replace(/\s+/,"|"),r);else{var s=e.split(/\s+/).map((function(e){return`(?=.*${e})`})).join("");o=new RegExp(`^${s}.*$`,r)}return o}(t,n,!1);e=e.filter((function(e){return o.test(e.title)||o.test(e.url)}))}return e}
/**
 * @license MIT <https://opensource.org/licenses/MIT>
 * @copyright Michael Hart 2024
 */
const n=new TextEncoder,o={appstream2:"appstream",cloudhsmv2:"cloudhsm",email:"ses",marketplace:"aws-marketplace",mobile:"AWSMobileHubService",pinpoint:"mobiletargeting",queue:"sqs","git-codecommit":"codecommit","mturk-requester-sandbox":"mturk-requester","personalize-runtime":"personalize"},r=new Set(["authorization","content-type","content-length","user-agent","presigned-expires","expect","x-amzn-trace-id","range","connection"]);class s{constructor({accessKeyId:e,secretAccessKey:t,sessionToken:n,service:o,region:r,cache:s,retries:i,initRetryMs:a}){if(null==e)throw new TypeError("accessKeyId is a required option");if(null==t)throw new TypeError("secretAccessKey is a required option");this.accessKeyId=e,this.secretAccessKey=t,this.sessionToken=n,this.service=o,this.region=r,this.cache=s||new Map,this.retries=null!=i?i:10,this.initRetryMs=a||50}async sign(e,t){if(e instanceof Request){const{method:n,url:o,headers:r,body:s}=e;null==(t=Object.assign({method:n,url:o,headers:r},t)).body&&r.has("Content-Type")&&(t.body=null!=s&&r.has("X-Amz-Content-Sha256")?s:await e.clone().arrayBuffer()),e=o}const n=new i(Object.assign({url:e.toString()},t,this,t&&t.aws)),o=Object.assign({},t,await n.sign());delete o.aws;try{return new Request(o.url.toString(),o)}catch(e){if(e instanceof TypeError)return new Request(o.url.toString(),Object.assign({duplex:"half"},o));throw e}}async fetch(e,t){for(let n=0;n<=this.retries;n++){const o=fetch(await this.sign(e,t));if(n===this.retries)return o;const r=await o;if(r.status<500&&429!==r.status)return r;await new Promise((e=>setTimeout(e,Math.random()*this.initRetryMs*Math.pow(2,n))))}throw new Error("An unknown error occurred, ensure retries is not negative")}}class i{constructor({method:e,url:t,headers:n,body:s,accessKeyId:i,secretAccessKey:a,sessionToken:c,service:u,region:l,cache:h,datetime:f,signQuery:p,appendSessionToken:m,allHeaders:g,singleEncode:b}){if(null==t)throw new TypeError("url is a required option");if(null==i)throw new TypeError("accessKeyId is a required option");if(null==a)throw new TypeError("secretAccessKey is a required option");let y,w;this.method=e||(s?"POST":"GET"),this.url=new URL(t),this.headers=new Headers(n||{}),this.body=s,this.accessKeyId=i,this.secretAccessKey=a,this.sessionToken=c,u&&l||([y,w]=function(e,t){const{hostname:n,pathname:r}=e;if(n.endsWith(".on.aws")){const e=n.match(/^[^.]{1,63}\.lambda-url\.([^.]{1,63})\.on\.aws$/);return null!=e?["lambda",e[1]||""]:["",""]}if(n.endsWith(".r2.cloudflarestorage.com"))return["s3","auto"];if(n.endsWith(".backblazeb2.com")){const e=n.match(/^(?:[^.]{1,63}\.)?s3\.([^.]{1,63})\.backblazeb2\.com$/);return null!=e?["s3",e[1]||""]:["",""]}const s=n.replace("dualstack.","").match(/([^.]{1,63})\.(?:([^.]{0,63})\.)?amazonaws\.com(?:\.cn)?$/);let i=s&&s[1]||"",a=s&&s[2];if("us-gov"===a)a="us-gov-west-1";else if("s3"===a||"s3-accelerate"===a)a="us-east-1",i="s3";else if("iot"===i)i=n.startsWith("iot.")?"execute-api":n.startsWith("data.jobs.iot.")?"iot-jobs-data":"/mqtt"===r?"iotdevicegateway":"iotdata";else if("autoscaling"===i){const e=(t.get("X-Amz-Target")||"").split(".")[0];"AnyScaleFrontendService"===e?i="application-autoscaling":"AnyScaleScalingPlannerFrontendService"===e&&(i="autoscaling-plans")}else null==a&&i.startsWith("s3-")?(a=i.slice(3).replace(/^fips-|^external-1/,""),i="s3"):i.endsWith("-fips")?i=i.slice(0,-5):a&&/-\d$/.test(i)&&!/-\d$/.test(a)&&([i,a]=[a,i]);return[o[i]||i,a||""]}(this.url,this.headers)),this.service=u||y||"",this.region=l||w||"us-east-1",this.cache=h||new Map,this.datetime=f||(new Date).toISOString().replace(/[:-]|\.\d{3}/g,""),this.signQuery=p,this.appendSessionToken=m||"iotdevicegateway"===this.service,this.headers.delete("Host"),"s3"!==this.service||this.signQuery||this.headers.has("X-Amz-Content-Sha256")||this.headers.set("X-Amz-Content-Sha256","UNSIGNED-PAYLOAD");const v=this.signQuery?this.url.searchParams:this.headers;if(v.set("X-Amz-Date",this.datetime),this.sessionToken&&!this.appendSessionToken&&v.set("X-Amz-Security-Token",this.sessionToken),this.signableHeaders=["host",...this.headers.keys()].filter((e=>g||!r.has(e))).sort(),this.signedHeaders=this.signableHeaders.join(";"),this.canonicalHeaders=this.signableHeaders.map((e=>e+":"+("host"===e?this.url.host:(this.headers.get(e)||"").replace(/\s+/g," ")))).join("\n"),this.credentialString=[this.datetime.slice(0,8),this.region,this.service,"aws4_request"].join("/"),this.signQuery&&("s3"!==this.service||v.has("X-Amz-Expires")||v.set("X-Amz-Expires","86400"),v.set("X-Amz-Algorithm","AWS4-HMAC-SHA256"),v.set("X-Amz-Credential",this.accessKeyId+"/"+this.credentialString),v.set("X-Amz-SignedHeaders",this.signedHeaders)),"s3"===this.service)try{this.encodedPath=decodeURIComponent(this.url.pathname.replace(/\+/g," "))}catch(e){this.encodedPath=this.url.pathname}else this.encodedPath=this.url.pathname.replace(/\/+/g,"/");b||(this.encodedPath=encodeURIComponent(this.encodedPath).replace(/%2F/g,"/")),this.encodedPath=d(this.encodedPath);const k=new Set;this.encodedSearch=[...this.url.searchParams].filter((([e])=>{if(!e)return!1;if("s3"===this.service){if(k.has(e))return!1;k.add(e)}return!0})).map((e=>e.map((e=>d(encodeURIComponent(e)))))).sort((([e,t],[n,o])=>e<n?-1:e>n?1:t<o?-1:t>o?1:0)).map((e=>e.join("="))).join("&")}async sign(){return this.signQuery?(this.url.searchParams.set("X-Amz-Signature",await this.signature()),this.sessionToken&&this.appendSessionToken&&this.url.searchParams.set("X-Amz-Security-Token",this.sessionToken)):this.headers.set("Authorization",await this.authHeader()),{method:this.method,url:this.url,headers:this.headers,body:this.body}}async authHeader(){return["AWS4-HMAC-SHA256 Credential="+this.accessKeyId+"/"+this.credentialString,"SignedHeaders="+this.signedHeaders,"Signature="+await this.signature()].join(", ")}async signature(){const e=this.datetime.slice(0,8),t=[this.secretAccessKey,e,this.region,this.service].join();let n=this.cache.get(t);if(!n){const o=await a("AWS4"+this.secretAccessKey,e),r=await a(o,this.region),s=await a(r,this.service);n=await a(s,"aws4_request"),this.cache.set(t,n)}return l(await a(n,await this.stringToSign()))}async stringToSign(){return["AWS4-HMAC-SHA256",this.datetime,this.credentialString,l(await c(await this.canonicalString()))].join("\n")}async canonicalString(){return[this.method.toUpperCase(),this.encodedPath,this.encodedSearch,this.canonicalHeaders+"\n",this.signedHeaders,await this.hexBodyHash()].join("\n")}async hexBodyHash(){let e=this.headers.get("X-Amz-Content-Sha256")||("s3"===this.service&&this.signQuery?"UNSIGNED-PAYLOAD":null);if(null==e){if(this.body&&"string"!=typeof this.body&&!("byteLength"in this.body))throw new Error("body must be a string, ArrayBuffer or ArrayBufferView, unless you include the X-Amz-Content-Sha256 header");e=l(await c(this.body||""))}return e}}async function a(e,t){const o=await crypto.subtle.importKey("raw","string"==typeof e?n.encode(e):e,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]);return crypto.subtle.sign("HMAC",o,n.encode(t))}async function c(e){return crypto.subtle.digest("SHA-256","string"==typeof e?n.encode(e):e)}const u=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function l(e){const t=new Uint8Array(e);let n="";for(let e=0;e<t.length;e++){const o=t[e];n+=u[o>>>4&15],n+=u[15&o]}return n}function d(e){return e.replace(/[!'()*]/g,(e=>"%"+e.charCodeAt(0).toString(16).toUpperCase()))}class h{constructor(){this.buffer=new Uint8Array(0)}parse(e){const t=new Uint8Array(this.buffer.length+e.length);t.set(this.buffer),t.set(e,this.buffer.length),this.buffer=t;const n=[];for(;this.buffer.length>=16;){const e=this.readInt32(0);if(this.buffer.length<e){console.log(this.buffer.length,e);break}const t=this.readInt32(4),o=this.parseHeaders(12,t),r=12+t,s=e-t-16,i=this.buffer.slice(r,r+s),a={headers:o,payload:this.decodePayload(i,o)};n.push(a),this.buffer=this.buffer.slice(e)}return n}readInt32(e){return this.buffer[e]<<24|this.buffer[e+1]<<16|this.buffer[e+2]<<8|this.buffer[e+3]}parseHeaders(e,t){const n={};let o=e;const r=e+t;for(;o<r;){const e=this.buffer[o++],t=(new TextDecoder).decode(this.buffer.slice(o,o+e));o+=e;const r=this.buffer[o++],s=this.buffer[o]<<8|this.buffer[o+1];o+=2;const i=this.parseHeaderValue(r,this.buffer.slice(o,o+s));o+=s,n[t]=i}return n}parseHeaderValue(e,t){switch(e){case 0:return!0;case 1:return!1;case 2:return t[0];case 3:return t[0]<<8|t[1];case 4:return t[0]<<24|t[1]<<16|t[2]<<8|t[3];case 5:return Number(new BigInt64Array(t.buffer)[0]);case 6:return t;case 7:return(new TextDecoder).decode(t);case 8:return new Date(Number(new BigInt64Array(t.buffer)[0]));default:throw new Error(`Unknown header value type: ${e}`)}}decodePayload(e,t){const n=t[":content-type"];return n?"application/json"===n?JSON.parse((new TextDecoder).decode(e)):n.startsWith("text/")?(new TextDecoder).decode(e):e:e}}let f=null;function p(e,t){if(!f)return t.onChunk("Please set up bedrock correctly."),void t.onComplete({});const n=new h;var o;f.fetch(`https://bedrock-runtime.us-west-2.amazonaws.com/model/${f.bedrockModel}/invoke-with-response-stream`,{method:"POST",headers:{accept:"application/vnd.amazon.eventstream","Content-Type":"application/json","x-amzn-bedrock-accept":"*/*"},aws:{service:"bedrock"},body:JSON.stringify({anthropic_version:"bedrock-2023-05-31",max_tokens:4096,top_k:250,temperature:1,top_p:.999,tools:e.tools,system:e.messages[0].content,messages:(o=e.messages.slice(1),o.map((e=>"string"==typeof e.content?{role:e.role,content:[{type:"text",text:e.content}]}:e)))})}).then((e=>{const o=e.body.getReader();let r={},s={};200==e.status?function e(){o.read().then((({done:o,value:i})=>{if(o)return;const a=n.parse(i);for(var c of a)if("exception"===c.headers[":message-type"])t.onChunk(c.payload.message),t.onComplete({});else{let e=JSON.parse(atob(c.payload.bytes));switch(e.type){case"message_start":s={role:e.message.role,content:[]};break;case"content_block_start":switch(e.content_block.type){case"text":r=e.content_block,t.onChunk(r.text);break;case"tool_use":r=e.content_block,r.input_json=""}break;case"content_block_delta":switch(e.delta.type){case"text_delta":t.onChunk(e.delta.text),r.text+=e.delta.text;break;case"input_json_delta":r.input_json+=e.delta.partial_json}break;case"content_block_stop":"tool_use"===r.type&&(r.input=JSON.parse(r.input_json),delete r.input_json),s.content.push(r);break;case"message_stop":t.onComplete(s)}}e()}))}():o.read().then((({done:e,value:n})=>{const o=(new TextDecoder).decode(n);t.onChunk(o),t.onComplete({})}))})).catch((e=>console.error("Error:",e)))}p.init=function(e){const t={accessKeyId:e.accessKeyId,secretAccessKey:e.secretAccessKey,sessionToken:e.sessionToken};f=new s(t),f.bedrockModel=e.model};const m={bedrock:p,deepseek:function e(t,n){const o=new TextDecoder;if(!e.apiKey)return n.onChunk("Please set api key for DeepSeek correctly."),void n.onComplete({});var r;fetch("https://api.deepseek.com/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:e.model||"deepseek-chat",stream:!0,messages:(r=t.messages,r.map((e=>"string"==typeof e.content?e:{role:e.role,content:e.content[0].text})))})}).then((e=>{const t=e.body.getReader();let r={type:"text",text:""};!function e(){t.read().then((({done:t,value:s})=>{if(t)return;const i=o.decode(s);try{const e=i.trim().split("\n\n"),t=/^data: /;for(const o of e){if(!t.test(o)){console.error("Unexpected line: ",o);continue}const e=o.replace(t,"");if("[DONE]"===e)return void n.onComplete({role:"assistant",content:[r]});const s=JSON.parse(e);s.choices&&s.choices[0].delta&&(n.onChunk(s.choices[0].delta.content),r.text+=s.choices[0].delta.content)}}catch(e){console.error("Error parsing chunk:",e,s)}e()}))}()})).catch((e=>console.error("Error:",e)))},gemini:function e(t,n){const o=new TextDecoder;if(!e.apiKey)return n.onChunk("Please set api key for Gemini correctly."),void n.onComplete({});let r=n.model||"gemini-2.0-flash";function s(e){return"string"==typeof e.content?{role:e.role,parts:[{text:e.content}]}:{role:e.role,parts:[{text:e.content[0].text}]}}fetch(`https://generativelanguage.googleapis.com/v1beta/models/${r}:streamGenerateContent?key=${e.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(function(e){let t={};if(e.length>0&&"system"===e[0].role){const n=e[0].content;t.systemInstruction={parts:[{text:n}]},t.contents=e.slice(1).map(s)}else t.contents=e.map(s);return t}(t.messages))}).then((e=>{const t=e.body.getReader();let r="",s={type:"text",text:""};!function e(){t.read().then((({done:t,value:i})=>{if(t)return;const a=o.decode(i);try{if(r+=a,"["!==r[0])return e();if("]"===r[r.length-1]){const e=JSON.parse(r);for(const t of e){if(t.error&&t.error.message)return n.onChunk(t.error.message),void n.onComplete({});t.candidates&&(t.candidates[0].content&&(n.onChunk(t.candidates[0].content.parts[0].text),s.text+=t.candidates[0].content.parts[0].text),t.candidates[0].finishReason&&"STOP"===t.candidates[0].finishReason&&n.onComplete({role:"assistant",content:[s]}))}r=""}}catch(e){console.error("Error parsing chunk:",e,i)}e()}))}()})).catch((e=>console.error("Error:",e)))},ollama:function e(t,n){const o=new TextDecoder;fetch("http://localhost:11434/api/chat",{method:"POST",body:JSON.stringify({model:e.model||"qwen2.5-coder:32b",tools:t.tools,messages:t.messages})}).then((e=>{const t=e.body.getReader();let r=[],s="";403==e.status?(n.onChunk("403 Forbidden, please restart Ollama with `OLLAMA_ORIGINS=chrome-extension://*`."),n.onComplete({})):function e(){t.read().then((({done:t,value:i})=>{if(!t){try{const e=o.decode(i).trim();for(const t of e.split("\n")){const e=JSON.parse(t);e.message.content&&(s+=e.message.content,n.onChunk(e.message.content)),e.message.tool_calls&&r.push(...e.message.tool_calls),e.done&&(e.message.content=e.message.content+s,e.message.tool_calls=r,n.onComplete(e.message))}}catch(e){console.error("Error in onChunk:",e,i)}e()}}))}()})).catch((e=>console.error("Error:",e)))}};function g(e,t,n,o,r){n=n||{};const s=/(?:charset|encoding)\s*=\s*['"]? *([\w\-]+)/i;fetch(e,{method:void 0!==o?"POST":"GET",headers:n,body:o}).then((e=>{const t=e.headers.get("content-type")?e.headers.get("content-type").match(s):[];return Promise.all([Promise.resolve(t&&t.length>1?t[1]:"utf-8"),e.arrayBuffer()])})).then((e=>{const n=new TextDecoder(e[0]).decode(e[1]);t(n)})).catch((e=>{r&&r(e)}))}function b(e,t){var n={};return e.forEach((function(e){n[e]=t})),n}function y(e,t){for(var n in t)e[n]=t[n]}function w(e,t){var n;return t?(t instanceof Array||(t=[t]),n={},t.forEach((function(t){n[t]=e[t]}))):n=e,n}function v(e,t,n){e===chrome.storage.sync?(t.localPath&&(delete t.snippets,delete t.localPath),Object.keys(t).length>1&&e.set(t,n)):t.localPath?(delete t.snippets,g(t.localPath,(function(o){t.snippets=o,e.set(t,n)}))):e.set(t,n)}var k=function(){var e={};var t,n="",o=[];function r(e,o){g(`https://api.github.com/gists/${n}/comments`,(function(e){o&&o(e)}),{Authorization:"token "+t},`{"body": "${encodeURIComponent(e)}"}`)}function s(e,o){g(`https://api.github.com/gists/${n}/comments/${e}`,(function(e){var t=JSON.parse(e);o({status:0,content:decodeURIComponent(t.body)})}),{Authorization:"token "+t})}function i(e){g(`https://api.github.com/gists/${n}/comments`,(function(t){o=JSON.parse(t).map((function(e){return e.id})),e(o)}),{Authorization:"token "+t})}function a(e,o,r){g(`https://api.github.com/gists/${n}/comments/${e}`,(function(e){r&&r(e)}),{Authorization:"token "+t},`{"body": "${encodeURIComponent(o)}"}`)}return e.initGist=function(e,o){if(t===e&&""!==n)return n;!function(e,t,n){g("https://api.github.com/gists",(function(o){var r=JSON.parse(o),s="";r.forEach((function(e){e.hasOwnProperty("description")&&e.description===t&&e.files.hasOwnProperty(t)&&(s=e.id)})),""===s?g("https://api.github.com/gists",(function(e){var t=JSON.parse(e);n(t.id)}),{Authorization:"token "+e},`{ "description": "${t}", "public": false, "files": { "${t}": { "content": "${t}" } } }`):n(s)}),{Authorization:"token "+e})}(t=e,"cloudboard",(function(e){n=e,o&&o(n)}))},e.readComment=function(e,t){""===n?t({status:1,content:"Please call initGist first!"}):e>=o.length?i((function(n){e<n.length?s(n[e],t):t({status:1,content:"Register not exists!"})})):s(o[e],t)},e.editComment=function(e,t,s){""===n?s({status:1,content:"Please call initGist first!"}):e>=o.length?i((function(n){if(e<n.length)a(n[e],t,s);else{var o=e-n.length+1;function i(){--o>0?r(".",i):0===o&&r(t,s)}i()}})):a(o[e],t,s)},e}();let x=!1;const S={};S.instance=function t(){return new Promise(((n,o)=>{const r=chrome.runtime.connectNative("surfingkeys"),s=function(){const e=new Uint32Array(8);return self.crypto.getRandomValues(e),Array.from(e).join("")}();r.onDisconnect.addListener((n=>{if(chrome.runtime.lastError)chrome.runtime.lastError.message;x?S.instance=t():(delete S.instance,e("warn","Failed to connect neovim, please make sure your neovim version 0.5 or above."))})),r.onMessage.addListener((async t=>{if(!0===t.status){if(x=!0,"serverStarted"===t.res.event){const e=`127.0.0.1:${t.res.port}/${s}`;n({url:e,nm:r})}}else t.err&&e("error",t.err)})),r.postMessage({startServer:!0,password:s})}))}(),function(e){var n={};const o=3===chrome.runtime.getManifest().manifest_version;var r=[],s=0,i=0,a=!1,c={},u={},l={},d=e._setNewTabUrl(),h={llm:{},focusAfterClosed:"right",repeatThreshold:99,tabsMRUOrder:!0,newTabPosition:"default",showTabIndices:!1,interceptedErrors:[]},f=[];function p(e,t){var n=t;if(""===e.title||e.hasOwnProperty("url")&&void 0!==e.url||(n+="/"+e.title,f.push({id:e.id,title:n+"/"})),e.hasOwnProperty("children"))for(var o=0;o<e.children.length;++o)p(e.children[o],n)}function w(e,t){e.path.length?chrome.bookmarks.create({parentId:e.folder,title:e.path.shift()},(function(n){e.folder=n.id,w(e,t)})):chrome.bookmarks.create({parentId:e.folder,title:e.title,url:e.url},(function(e){t(e)}))}function x(t,n){e.loadRawSettings(t,(function(e){"string"==typeof e.proxy&&(e.proxy=[e.proxy],e.autoproxy_hosts=[e.autoproxy_hosts]),e.localPath?g(U(e.localPath),(function(t){e.snippets=t,n(e)}),void 0,void 0,(function(t){e.error="Failed to read snippets from "+e.localPath,n(e)})):n(e)}),{blocklist:{},marks:{},findHistory:[],cmdHistory:[],sessions:{},proxyMode:"clear",autoproxy_hosts:[],proxy:[]})}function S(e){if(u.hasOwnProperty(e)){const t=u[e];T(e,0,{subject:"setScrollPos",scrollLeft:t.scrollLeft,scrollTop:t.scrollTop}),delete u[e]}}function T(e,t,n){const o=-1===t?void 0:{frameId:t},r=chrome.tabs.sendMessage(e,n,o);r&&r.catch((e=>{}))}x(null,e._applyProxySettings),chrome.tabs.onRemoved.addListener((function(e){delete c[e],delete u[e],delete l[e],r=r.filter((function(t){return t!==e})),X.length&&chrome.tabs.create({active:!1,url:X.shift()}),E()}));var I=null;function A(e){I!==e&&(null!==I&&T(I,0,{subject:"tabDeactivated"}),T(e,0,{subject:"tabActivated"}),I=e)}function P(e){chrome.tabs.query({active:!0,currentWindow:!0},(function(t){t.length>0&&e(t[0])}))}function C(e,t,o){var r=n.pendingPorts.indexOf(e);-1!==r&&n.pendingPorts.splice(r,1),t(o)}function O(e,t,o){if(n.hasOwnProperty(e.action)){e.repeats>h.repeatThreshold&&(e.repeats=h.repeatThreshold);var r=n[e.action](e,t,o);if(e.needResponse)return r?(o(r),e.needResponse=!1):n.pendingPorts.push(e),e.needResponse}else console.log("[unexpected runtime message] "+JSON.stringify(e))}function R(e){chrome.tabs.query({},(function(t){t.forEach((function(t){T(t.id,-1,{subject:"settingsUpdated",settings:e})}))}))}function L(e,t){R(e),function(e,t){e.savedAt=(new Date).getTime(),v(chrome.storage.local,e,(function(){v(chrome.storage.sync,e,(function(){chrome.runtime.lastError&&chrome.runtime.lastError.message})),t&&t()}))}(e,t)}function E(){h.showTabIndices&&chrome.tabs.query({currentWindow:!0},(function(e){e.forEach((function(e){T(e.id,0,{subject:"tabIndexChange",index:e.index+1})}))}))}function _(e){return 0!==e.frameId&&"about:blank"===e.url?e.tab.url:e.url}function q(e,t,n,o){if(e.blocklist[".*"])return"disabled";if(t){if(e.blocklist[t.origin])return"disabled";if(n&&(n=new RegExp(n.source,n.flags)).test(t.href))return"disabled";if(o&&(o=new RegExp(o.source,o.flags)).test(t.href))return"lurking"}return"enabled"}function U(e){if(/https?:\/\//.test(e)){e=`${e=e.replace(/\?$/,"")}${new URL(e).search?"&":"?"}nonce=${(new Date).getTime()}`}return e}function M(e,n){return t(e=e.filter((function(e){return e.url})),n,!1)}function j(t,n,o,r){e.getLatestHistoryItem(t,n,(e=>{r&&(e=e.sort((function(e,t){return t.visitCount-e.visitCount}))),o(e)}))}function H(e,t){chrome.windows.update(e,{focused:!0},(function(){chrome.tabs.update(t,{active:!0})}))}function $(e,t){return e<0?e=0:e>=t&&(e=t),e}function N(e,t){e?chrome.tabs.query({windowId:e.windowId},(function(n){0==e.index&&-1==t?t=n.length-1:e.index==n.length-1&&1==t&&(t=1-n.length);var o=$(e.index+t,n.length-1);chrome.tabs.update(n[o].id,{active:!0})})):P((function(e){N(e,t)}))}function D(e,t,n){e?chrome.tabs.query({windowId:e.windowId},(function(o){var r=o.map((function(e){return e.id}));t=$(t,o.length);var s=function(e,t,n){return t>n-e&&(e-=t-(n-e)),e}(e.index,t,o.length);n(r.slice(s,s+t))})):P((function(e){D(e,t,n)}))}function z(e,t){chrome.tabs.query({currentWindow:!0},(function(n){n=n.map((function(e){return e.id})),chrome.tabs.remove(n.slice(e.tab.index+(t<0?t:1),e.tab.index+(t<0?0:1+t)))}))}chrome.tabs.onUpdated.addListener((function(t,n,o){"complete"===n.status&&o.active&&A(t),e.detectTabTitleChange&&n.title&&T(t,0,{subject:"titleChanged",changeInfo:n})})),chrome.windows.onFocusChanged.addListener((function(e){P((function(e){A(e.id)}))})),chrome.tabs.onCreated.addListener((function(e){E()})),chrome.tabs.onMoved.addListener((function(){E()})),chrome.tabs.onActivated.addListener((function(e){a||e.tabId==r[r.length-1]||(r.length>10&&r.shift(),s!=r.length-1&&r.splice(s+1,r.length-1),r.push(e.tabId),s=r.length-1),c[e.tabId]=(new Date).getTime(),A(e.tabId),a=!1,i=0,E()})),chrome.tabs.onDetached.addListener((function(){E()})),chrome.tabs.onAttached.addListener((function(){E()})),chrome.commands.onCommand.addListener((function(e){switch(e){case"restartext":chrome.tabs.query({},(function(e){e.forEach((function(e){chrome.tabs.reload(e.id)})),chrome.runtime.reload()}));break;case"previousTab":case"nextTab":P((function(t){var n="previousTab"===e?t.index-1:t.index+1;chrome.tabs.query({windowId:t.windowId},(function(e){n=(n%e.length+e.length)%e.length,chrome.tabs.update(e[n].id,{active:!0})}))}));break;case"closeTab":P((function(e){chrome.tabs.remove(e.id)}));break;case"proxyThis":P((function(e){J({host:new URL(e.url||e.pendingUrl).host,operation:"toggle"},(function(){chrome.tabs.reload(e.id,{bypassCache:!0})}))}))}})),n.pendingPorts=[],chrome.runtime.onMessage.addListener(O),o&&(chrome.runtime.onUserScriptMessage.addListener(((e,t,n)=>{e.fromUserScript=!0,O(e,t,n)})),chrome.runtime.onInstalled.addListener((e=>{chrome.userScripts.configureWorld({csp:"script-src 'self' 'unsafe-eval'",messaging:!0})}))),n.toggleBlocklist=function(e,t,n){x("blocklist",(function(o){var r=".*",s=t.origin||new URL(_(t)).origin;0!==chrome.runtime.getURL("/").indexOf(s)&&"null"!==s&&(r=s),o.blocklist.hasOwnProperty(r)?delete o.blocklist[r]:o.blocklist[r]=1,L({blocklist:o.blocklist},(function(){n({state:q(o,t.tab?new URL(_(t)):null,e.blocklistPattern,e.lurkingPattern),blocklist:o.blocklist,url:r})}))}))},n.toggleMouseQuery=function(e,t,n){x("mouseSelectToQuery",(function(n){if(t.tab&&0!==t.tab.url.indexOf(chrome.runtime.getURL("/"))){var o=n.mouseSelectToQuery||[],r=o.indexOf(e.origin);-1===r?o.push(e.origin):o.splice(r,1),L({mouseSelectToQuery:o})}}))},n.getState=function(e,t,n){x(["blocklist","noPdfViewer","proxyMode","proxy"],(function(o){t.tab&&C(e,n,{noPdfViewer:o.noPdfViewer,proxyMode:o.proxyMode,proxy:o.proxy,state:q(o,new URL(_(t)),e.blocklistPattern,e.lurkingPattern)})}))},n.addVIMark=function(e,t,n){x("marks",(function(t){y(t.marks,e.mark),L({marks:t.marks})}))},n.jumpVIMark=function(e,t,o){x("marks",(function(r){var s=r.marks;if(s.hasOwnProperty(e.mark)){var i=s[e.mark];chrome.tabs.query({},(function(e){0===(e=e.filter((function(e){return e.url===i.url}))).length?(i.tab={tabbed:!0,active:!0},n.openLink(i,t,o)):((i.scrollLeft||i.scrollTop)&&(u[e[0].id]={scrollLeft:i.scrollLeft,scrollTop:i.scrollTop}),e[0].id===t.tab.id?S(e[0].id):chrome.tabs.update(e[0].id,{active:!0}))}))}}))},n.resetSettings=function(t,n,o){chrome.storage.local.clear(),chrome.storage.sync.clear(),x(null,(function(n){e._applyProxySettings(n),C(t,o,{settings:n}),R(n)}))},n.loadSettingsFromUrl=function(e,t,n){var o,r;o=e.url,r=function(t){C(e,n,t)},g(U(o),(function(e){L({localPath:o,snippets:e}),r({status:"Succeeded",snippets:e})}),void 0,void 0,(function(e){r({status:"Failed"})}))},n.getRecentlyClosed=function(e,t,n){chrome.sessions.getRecentlyClosed({},(function(t){for(var o=[],r=0;r<t.length;r++){var s=t[r];s.hasOwnProperty("window")?o=o.concat(s.window.tabs):s.hasOwnProperty("tab")&&o.push(s.tab)}o=M(o,e.query),C(e,n,{urls:o})}))},n.getTopSites=function(e,t,n){chrome.topSites?chrome.topSites.get((function(t){t=M(t,e.query),C(e,n,{urls:t})})):C(e,n,{urls:[]})},n.getAllURLs=function(e,t,n){chrome.bookmarks.search(e.query||{},(function(t){var o=t,r=e.maxResults||100,s=r-o.length;s>0?j(e.query||"",s,(function(t){o=o.concat(t),C(e,n,{urls:o})}),!0):C(e,n,{urls:o.slice(0,r)})}))},n.getTabs=function(e,t,n){var o=t.tab,r=e.queryInfo||{};chrome.tabs.query(r,(function(t){(t=M(t,e.filter)).length>e.tabsThreshold&&h.tabsMRUOrder&&(t=t.filter((function(e){return e.id!==o.id}))).sort((function(e,t){var n=e.lastAccessed||c[e.id],o=t.lastAccessed||c[t.id];return isFinite(n)||isFinite(o)?isFinite(n)?isFinite(o)?o-n:-1:1:0})),C(e,n,{tabs:t})}))},n.createTabGroup=function(e,t,n){chrome.tabs.group({tabIds:[t.tab.id],groupId:e.groupId},(function(t){(e.title||e.color)&&chrome.tabGroups.update(t,{title:e.title,color:e.color})}))},n.ungroupTab=function(e,t,n){chrome.tabs.ungroup([t.tab.id])},n.collapseGroup=function(e,t,n){chrome.tabGroups.update(e.groupId,{collapsed:e.collapsed})},n.getTabGroups=function(e,t,n){chrome.tabGroups.query({},(function(o){let r=-1;chrome.tabs.query({},(function(s){const i={};s.forEach((function(e){e.groupId&&e.groupId!==chrome.tabGroups.TAB_GROUP_ID_NONE&&(i[e.groupId]||(i[e.groupId]=[]),e.id===t.tab.id&&(r=e.groupId),i[e.groupId].push({id:e.id,title:e.title,url:e.url,active:e.active,index:e.index}))})),(o=o.filter((e=>!e.hermit))).forEach((function(e){e.tabs=i[e.id]||[],e.active=e.id===r})),C(e,n,{groups:o})}))}))},n.togglePinTab=function(e,t,n){P((function(e){return chrome.tabs.update(e.id,{pinned:!e.pinned})}))},n.focusTab=function(e,t,n){void 0!==e.windowId&&t.tab.windowId!==e.windowId?H(e.windowId,e.tabId):chrome.tabs.update(e.tabId,{active:!0})},n.focusTabByIndex=function(e,t,n){var o=e.queryInfo||{currentWindow:!0};chrome.tabs.query(o,(function(t){e.repeats>0&&e.repeats<=t.length&&chrome.tabs.update(t[e.repeats-1].id,{active:!0})}))},n.goToLastTab=function(e,t,n){if(r.length>1){var o=r[r.length-2];chrome.tabs.update(o,{active:!0})}},n.historyTab=function(e,t,n){if(r.length>0){a=!0,e.hasOwnProperty("index")?s=(parseInt(e.index)+r.length)%r.length:(s+=e.backward?-1:1)<0?s=0:s>=r.length&&(s=r.length-1);const t=r[s];chrome.tabs.update(t,{active:!0})}},n.nextTab=function(e,t,n){N(t.tab,e.repeats)},n.previousTab=function(e,t,n){N(t.tab,-e.repeats)},n.reloadTab=function(e,t,n){D(t.tab,e.repeats,(function(t){t.forEach((function(t){chrome.tabs.reload(t,{bypassCache:e.nocache})}))}))},n.closeTab=function(e,t,o){D(t.tab,e.repeats,(function(e){chrome.tabs.remove(e,(function(){"left"===h.focusAfterClosed?N(t.tab,-1):"last"===h.focusAfterClosed&&n.historyTab({backward:!0})}))}))},n.closeTabLeft=function(e,t,n){z(t,-e.repeats)},n.closeTabRight=function(e,t,n){z(t,e.repeats)},n.closeTabsToLeft=function(e,t,n){z(t,-t.tab.index)},n.closeTabsToRight=function(e,t,n){chrome.tabs.query({currentWindow:!0},(function(e){z(t,e.length-t.tab.index)}))},n.tabOnly=function(e,t,n){chrome.tabs.query({currentWindow:!0},(function(e){e=e.filter((function(e){return e.id!=t.tab.id&&!e.pinned})).map((function(e){return e.id})),chrome.tabs.remove(e)}))},n.closeAudibleTab=function(e,t,n){chrome.tabs.query({audible:!0},(function(e){e&&chrome.tabs.remove(e[0].id)}))},n.muteTab=function(e,t,n){var o=t.tab;chrome.tabs.update(o.id,{muted:!o.mutedInfo.muted})},n.openLast=function(t,n,o){"Safari"===e.name?chrome.runtime.sendNativeMessage("application.id",{command:"reopenLastTab"},(function(e){C(t,o,e)})):chrome.sessions.restore()},n.duplicateTab=function(e,t,n){chrome.tabs.duplicate(t.tab.id,(function(){!1===e.active&&chrome.tabs.update(t.tab.id,{active:!0})}))};let G=-1;function K(e,t,n){return e.filter((function(e){var o=e.title,r=e.url;return n||(o=o.toLowerCase(),r=r&&r.toLowerCase(),t=t.toLowerCase()),-1!==o.indexOf(t)||r&&-1!==r.indexOf(t)}))}function W(e,t,n){var o;if(e)switch(h.newTabPosition){case"left":o=e.index;break;case"right":o=e.index+1;break;case"first":o=0;break;case"last":break;default:o=e.index+1+i,i++}chrome.tabs.create({url:t,active:n.tab.active,index:o,pinned:n.tab.pinned,openerTabId:e.id},(function(e){(n.scrollLeft||n.scrollTop)&&(u[e.id]={scrollLeft:n.scrollLeft,scrollTop:n.scrollTop})}))}function F(){try{if(chrome.userScripts)return!0}catch{return!1}return!1}function B(){chrome.windows.getAll({populate:!1},(function(e){e.forEach((function(e){chrome.windows.remove(e.id)}))}))}function J(t,n){x(["proxyMode","proxy","autoproxy_hosts"],(function(o){if("deleteProxyPair"===t.operation)o.proxy.splice(t.number,1),o.autoproxy_hosts.splice(t.number,1);else if("set"===t.operation)o.proxyMode=t.mode,o.proxy=t.proxy,o.autoproxy_hosts=t.host;else if(t.mode&&(o.proxyMode=t.mode),t.number||(t.number=0),t.proxy&&(o.proxy[t.number]=t.proxy,o.autoproxy_hosts.length<=t.number&&(o.autoproxy_hosts[t.number]=[])),t.host){var r=b(o.autoproxy_hosts[t.number],1),s=t.host.split(/\s*[ ,\n]\s*/);"toggle"===t.operation?s.forEach((function(e){r.hasOwnProperty(e)?delete r[e]:r[e]=1})):"add"===t.operation?s.forEach((function(e){r[e]=1})):s.forEach((function(e){delete r[e]})),o.autoproxy_hosts[t.number]=Object.keys(r)}var i={autoproxy_hosts:o.autoproxy_hosts,proxyMode:o.proxyMode,proxy:o.proxy};L(i),e._applyProxySettings(o),n&&n(i)}))}function V(e,t){chrome.bookmarks.search({url:e},(function(e){e.forEach((function(e){chrome.bookmarks.remove(e.id)})),t&&t()}))}n.getWindows=function(e,t,n){chrome.tabs.query({currentWindow:!1},(function(t){const o={};t.forEach((e=>{const t=o[e.windowId]||[];t.push({title:e.title,url:e.url}),o[e.windowId]=t})),C(e,n,{windows:Object.keys(o).map((e=>({id:e,tabs:o[e],isPreviousChoice:parseInt(e)===G})))})}))},n.moveToWindow=function(e,t,n){-1===e.windowId?chrome.windows.create({tabId:t.tab.id}):chrome.tabs.move(t.tab.id,{windowId:e.windowId,index:-1},(()=>{H(e.windowId,t.tab.id)})),G=e.windowId},n.gatherWindows=function(e,t,n){const o=t.tab.windowId;chrome.tabs.query({currentWindow:!1},(function(e){e.forEach((function(e){chrome.tabs.move(e.id,{windowId:o,index:-1})}))}))},n.gatherTabs=function(e,t,n){const o=t.tab.windowId;e.tabs.forEach((function(e){chrome.tabs.move(e.id,{windowId:o,index:-1})}))},n.getBookmarkFolders=function(e,t,n){chrome.bookmarks.getTree((function(t){f=[],p(t[0],""),C(e,n,{folders:f})}))},n.createBookmark=function(e,t,n){V(e.page.url,(function(){w(e.page,(function(t){C(e,n,{bookmark:t})}))}))},n.getBookmarks=function(e,t,n){e.parentId?chrome.bookmarks.getSubTree(e.parentId,(function(t){var o=t[0].children;e.query&&e.query.length&&(o=K(o,e.query,e.caseSensitive)),C(e,n,{bookmarks:o})})):e.query&&e.query.length?chrome.bookmarks.search(e.query,(function(t){C(e,n,{bookmarks:K(t,e.query,e.caseSensitive)})})):chrome.bookmarks.getTree((function(t){C(e,n,{bookmarks:t[0].children})}))},n.getHistory=function(e,t,n){j(e.query||"",e.maxResults||100,(function(t){C(e,n,{history:t})}),e.sortByMostUsed)},n.addHistories=function(e,t,n){e.history.forEach((e=>{chrome.history.addUrl({url:e})}))},n.openLink=function(e,t,n){var o=function(e){return!/^view-source:|^javascript:/.test(e)&&/^(?:https?:\/\/)?(?:[^@\/\n]+@)?(?:www\.)?([^:\/\n]+)/im.test(e)&&(/^[\w-]+?:/i.test(e)||(e="http://"+e)),e}(e.url);o.startsWith("javascript:")?T(t.tab.id,0,{subject:"showBanner",message:"JavaScript URLs are not allowed in such operation."}):e.tab.tabbed?0!==t.frameId&&chrome.runtime.getURL("pages/frontend.html")===t.url||!t.tab?P((function(t){W(t,o,e)})):W(t.tab,o,e):chrome.tabs.update({url:o,pinned:e.tab.pinned||t.tab.pinned},(function(t){(e.scrollLeft||e.scrollTop)&&(u[t.id]={scrollLeft:e.scrollLeft,scrollTop:e.scrollTop})}))},n.viewSource=function(e,t,o){e.url="view-source:"+t.tab.url,n.openLink(e,t,o)},n.getSettings=function(t,n,r){var s=x;"RAW"===t.key&&(s=e.loadRawSettings,t.key=""),s(t.key,(function(n){void 0===t.key&&function(t){if(t.isMV3=o,t.useNeovim=e.nvimServer&&e.nvimServer.instance,t.isUserScriptsAvailable=F(),o&&(t.showAdvanced=t.isUserScriptsAvailable&&t.showAdvanced),t.isUserScriptsAvailable){const e="settingsSnippets";if(t.showAdvanced&&t.snippets){const n=t.snippets;chrome.userScripts.getScripts({ids:[e]},(t=>{const o=`import('./api.js').then((module) => {module.default("${chrome.runtime.getURL("/")}", (api, settings) => {${n}\n})});`,r=()=>{chrome.userScripts.register([{allFrames:!0,id:e,matches:["*://*/*","file:///*"],js:[{code:o}]}])};t.length>0?t[0].js[0].code!==o&&chrome.userScripts.unregister({ids:[e]},r):r()}))}else chrome.userScripts.getScripts({ids:[e]},(t=>{t.length>0&&chrome.userScripts.unregister({ids:[e]})}))}}(n),C(t,r,{settings:n})}))},n.updateSettings=function(e,t,n){let r="";if("snippets"===e.scope){for(var s in e.settings)h.hasOwnProperty(s)&&(h[s]=e.settings[s]);const t=h.llm;t.ollama&&t.ollama.model&&(m.ollama.model=t.ollama.model),t.deepseek&&t.deepseek.apiKey&&(m.deepseek.apiKey=t.deepseek.apiKey,m.deepseek.model=t.deepseek.model,delete e.settings.llm.deepseek),t.gemini&&t.gemini.apiKey&&(m.gemini.apiKey=t.gemini.apiKey,m.gemini.model=t.gemini.model,delete e.settings.llm.gemini),t.bedrock&&t.bedrock.accessKeyId&&t.bedrock.secretAccessKey&&t.bedrock.model&&(m.bedrock.init(t.bedrock),delete e.settings.llm.bedrock)}else e.settings.showAdvanced&&o?F()?(chrome.userScripts.configureWorld({csp:"script-src 'self' 'unsafe-eval'",messaging:!0}),L(e.settings)):r="Advanced mode is only available when Developer mode is turned on from chrome://extensions/.":L(e.settings);return{error:r}},n.updateInputHistory=function(e,t,n){let o,r;for(var s in e){o=s+"History",r=e[s];break}o&&x(o,(function(t){let s=t[o]||[],i={};"Array"===r.constructor.name?(i[o]=r,L(i)):r.trim().length&&"."!==r&&(s=s.filter((function(e){return e.trim().length&&e!==r&&"."!==e})),s.unshift(r),s.length>50&&s.pop(),i[o]=s,L(i)),C(e,n,{history:s})}))},n.setSurfingkeysIcon=function(e,t,n){let r="icons/48.png";"disabled"===e.status?r="icons/48-x.png":"lurking"===e.status&&(r="icons/48-l.png");(o?chrome.action:chrome.browserAction).setIcon({path:r,tabId:t.tab?t.tab.id:void 0})},n.request=function(e,t,n){g(e.url,(function(t){C(e,n,{text:t})}),e.headers,e.data,(t=>{C(e,n,{error:t.toString()})}))},n.requestImage=function(e,t,n){fetch(e.url,{method:"GET"}).then((e=>e.blob())).then((e=>createImageBitmap(e))).then((t=>{const o=new OffscreenCanvas(t.width,t.height);o.getContext("2d").drawImage(t,0,0,o.width,o.height),o.convertToBlob().then((t=>{const o=new FileReader;o.onload=function(t){C(e,n,{text:t.target.result})},o.readAsDataURL(t)}))})).catch((t=>{C(e,n,{text:""})}))},n.nextFrame=function(e,t,n){const o=t.tab.id;chrome.scripting.executeScript({target:{allFrames:!0,tabId:o},func:()=>"function"==typeof getFrameId?getFrameId():0},(function(t){if((t=t.map((e=>e.result)).filter((e=>e))).length>0){let n=0;for(n=0;n<t.length&&t[n]!==e.frameId;n++);n=n===t.length-1?0:n+1,T(o,-1,{subject:"focusFrame",frameId:t[n]})}}))},n.moveTab=function(e,t,n){chrome.tabs.query({windowId:t.tab.windowId},(function(n){var o=$(t.tab.index+e.step*e.repeats,n.length);chrome.tabs.move(t.tab.id,{index:o})}))},n.quit=function(e,t,n){B()},n.createSession=function(e,t,n){x("sessions",(function(t){chrome.tabs.query({},(function(n){var o={};n.forEach((function(e){e&&void 0!==e.index&&(o.hasOwnProperty(e.windowId)||(o[e.windowId]=[]),e.url!==d&&o[e.windowId].push(e.url))}));var r=[];for(var s in o)o[s].length&&r.push(o[s]);t.sessions[e.name]={},t.sessions[e.name].tabs=r,L({sessions:t.sessions},e.quitAfterSaved?B:void 0)}))}))},n.openSession=function(e,t,n){x("sessions",(function(t){if(t.sessions.hasOwnProperty(e.name)){var n=t.sessions[e.name].tabs;n[0].forEach((function(e){chrome.tabs.create({url:e,active:!1,pinned:!1})}));for(var o=1;o<n.length;o++){var r=n[o];chrome.windows.create({},(function(e){r.forEach((function(t){chrome.tabs.create({windowId:e.id,url:t,active:!1,pinned:!1})}))}))}chrome.tabs.query({url:d},(function(e){chrome.tabs.remove(e.map((function(e){return e.id})))}))}}))},n.deleteSession=function(e,t,n){x("sessions",(function(t){delete t.sessions[e.name],L({sessions:t.sessions})}))},n.closeDownloadsShelf=function(e,t,n){e.clearHistory?chrome.downloads.erase({urlRegex:".*"}):(chrome.downloads.setShelfEnabled(!1),chrome.downloads.setShelfEnabled(!0))},n.getDownloads=function(e,t,n){chrome.downloads.search(e.query,(function(t){C(e,n,{downloads:t})}))},n.download=function(e,t,n){chrome.downloads.download({url:e.url,saveAs:e.saveAs})},n.tabURLAccessed=function(e,t,n){if(t.tab){var o=t.tab.id;return S(o),l.hasOwnProperty(o)||(l[o]={}),l[o][e.url]=e.title,{active:t.tab.active,index:h.showTabIndices?t.tab.index+1:0}}return{}},n.getTabURLs=function(e,t,n){var o=l[t.tab.id]||{};return{urls:o=Object.keys(o).map((function(e){return{url:e,title:o[e]}}))}},n.getTopURL=function(e,t,n){return{url:t.tab?t.tab.url:""}},n.updateProxy=function(e,t,n){J(e,(function(t){C(e,n,t)}))},n.setZoom=function(e,t,n){var o=t.tab.id,r=e.zoomFactor*e.repeats;0==r?chrome.tabs.getZoomSettings(o,(function(e){const t=e.defaultZoomFactor?e.defaultZoomFactor:1;chrome.tabs.setZoom(o,t)})):chrome.tabs.getZoom(o,(function(e){chrome.tabs.setZoom(o,e+r)}))},n.removeURL=function(e,t,n){var o=0,r=e.uid.length,s=e.uid;function i(){++o===r&&C(e,n,{response:"Done"})}"string"==typeof e.uid&&(r=1,s=[e.uid]),s.forEach((function(e){!function(e,t){var n=e[0];e=e.substr(1),"B"===n?chrome.bookmarks.remove(e,t):"H"===n?chrome.history.deleteUrl({url:e},t):"T"===n?(e=e.split(":").map((function(e){return parseInt(e)})),chrome.windows.update(e[0],{focused:!0},(function(){chrome.tabs.remove(e[1],t)}))):"M"===n&&x("marks",(function(n){delete n.marks[e],L({marks:n.marks},t)}))}(e,i)}))},n.localData=function(e,t,n){e.data.constructor===Object?(chrome.storage.local.set(e.data,(function(){})),R(e.data)):chrome.storage.local.get(e.data,(function(t){C(e,n,{data:t})}))},n.captureVisibleTab=function(e,t,n){chrome.tabs.captureVisibleTab(null,{format:"png"},(function(t){C(e,n,{dataUrl:t})}))},n.getCaptureSize=function(e,t,n){var o=document.createElement("img");o.onload=function(){C(e,n,{width:o.width,height:o.height})},chrome.tabs.captureVisibleTab(null,{format:"png"},(function(e){o.src=e}))},n.deleteHistoryOlderThan=function(e,t,n){var o=e.days||0,r=e.hours||0;chrome.history.deleteRange({startTime:0,endTime:(new Date).getTime()-1e3*(86400*o+3600*r)},(function(){}))},n.removeBookmark=function(e,t,n){V(t.tab.url)},n.getBookmark=function(e,t,n){chrome.bookmarks.search({url:t.tab.url},(function(t){C(e,n,{bookmarks:t})}))},n.initGist=function(e,t,n){return k.initGist(e.token,(function(t){C(e,n,{gist:t})}))},n.readComment=function(e,t,n){k.readComment(e.index,(function(t){C(e,n,t)}))},n.editComment=function(e,t,n){k.editComment(e.index,e.content,(function(t){C(e,n,{gistResp:t})}))};var X=[];function Q(e){try{return decodeURIComponent(escape(e))}catch{return e}}n.queueURLs=function(e,t,n){X=X.concat(e.urls)},n.getQueueURLs=function(e,t,n){return{queueURLs:X}},n.clearQueueURLs=function(e,t,n){X=[]},n.getVoices=function(e,t,n){chrome.tts.getVoices((function(t){C(e,n,{voices:t})}))},n.read=function(e,t,n){var o=e.options||{};o.onEvent=function(o){"start"===o.type?C(e,n,{ttsEvent:o}):T(t.tab.id,-1,{subject:"onTtsEvent",ttsEvent:o})},chrome.tts.speak(e.content,o)},n.stopReading=function(e,t,n){chrome.tts.stop()},n.openIncognito=function(e,t,n){chrome.windows.create({url:e.url,incognito:!0})},n.writeClipboard=function(e,t,n){navigator.clipboard.writeText(e.text)},n.readClipboard=function(e,t,n){chrome.runtime.sendNativeMessage("application.id",{command:"Clipboard.read"},(function(t){C(e,n,t)}))};let Z={tabId:0,frameId:0};const Y=(t,n,o)=>{"Safari"===e.name?chrome.runtime.sendMessage(o):T(t,n,o)};n.llmRequest=function(e,t,n){Z.tabId=t.tab.id,Z.frameId=t.frameId;new TextDecoder;const o=e.provider;if(m.hasOwnProperty(o)){(0,m[o])(e,{onComplete:e=>{e.content&&"Array"===e.content.constructor.name&&(e.content=e.content.map((e=>"text"===e.type?{type:"text",text:Q(e.text)}:e))),Y(Z.tabId,Z.frameId,{subject:"llmResponse",message:e,done:!0})},onChunk:e=>{Y(Z.tabId,Z.frameId,{subject:"llmResponse",chunk:Q(e)})}})}else Y(Z.tabId,Z.frameId,{subject:"llmResponse",chunk:`**Warning:** There is no LLM provider ${o} implemented.`})},n.getAllLlmProviders=function(e,t,n){C(e,n,{providers:Object.keys(m)})},n.getContainerName=e._getContainerName(n,C),chrome.runtime.setUninstallURL("http://brookhong.github.io/2018/01/30/why-did-you-uninstall-surfingkeys.html"),n.connectNative=function(t,n,o){e.nvimServer&&e.nvimServer.instance&&e.nvimServer.instance.then((({url:e,nm:n})=>{n.postMessage({mode:t.mode}),C(t,o,{url:e})})).catch((e=>{C(t,o,{error:e})}))}}({name:"Chrome",detectTabTitleChange:!0,getLatestHistoryItem:function(e,n,o){e.toLowerCase();let r=(new Date).getTime(),s=[];const i=(n,o,r)=>{const a=o*Math.pow(10,Math.min(2,e.length));chrome.history.search({startTime:0,endTime:n,text:"",maxResults:a},(function(a){const c=t(a,e,!1);s=[...s,...c],a.length<o||s.length>=o?r(s.slice(0,o)):(n=a[a.length-1].lastVisitTime-.01,i(n,o,r))}))};i(r,n,o)},loadRawSettings:function(e,t,n){var o=n||{};chrome.storage.local.get(null,(function(n){var r=n.savedAt||0;chrome.storage.sync.get(null,(function(s){var i=s.savedAt||0;r>i?(y(o,n),v(chrome.storage.sync,n,(function(){var n=w(o,e);chrome.runtime.lastError&&(n.error="Settings sync may not work thoroughly because of: "+chrome.runtime.lastError.message),t(n)}))):r<i?(delete s.localPath,y(o,s),t(w(o,e)),v(chrome.storage.local,s)):(y(o,n),t(w(o,e)))}))}))},nvimServer:S,_applyProxySettings:function(e){if(e.proxyMode&&"clear"!==e.proxyMode){var t=e.autoproxy_hosts.map((function(e){return e.filter((function(e){return-1!==e.indexOf("*")})).join("|")})),n=e.autoproxy_hosts.map((function(e){return b(e.filter((function(e){return-1===e.indexOf("*")})),1)})),o={mode:-1!==["always","byhost","bypass"].indexOf(e.proxyMode)?"pac_script":e.proxyMode,pacScript:{data:`var pacGlobal = {\n                        hosts: ${JSON.stringify(n)},\n                        autoproxy_pattern: ${JSON.stringify(t)},\n                        proxyMode: '${e.proxyMode}',\n                        proxy: ${JSON.stringify(e.proxy)}\n                    };\n                    function FindProxyForURL(url, host) {\n                        var lastPos;\n                        if (pacGlobal.proxyMode === "always") {\n                            return pacGlobal.proxy[0];\n                        } else if (pacGlobal.proxyMode === "bypass") {\n                            var pp = new RegExp(pacGlobal.autoproxy_pattern[0]);\n                            do {\n                                if (pacGlobal.hosts[0].hasOwnProperty(host)\n                                    || (pacGlobal.autoproxy_pattern[0].length && pp.test(host))) {\n                                    return "DIRECT";\n                                }\n                                lastPos = host.indexOf('.') + 1;\n                                host = host.slice(lastPos);\n                            } while (lastPos >= 1);\n                            return pacGlobal.proxy[0];\n                        } else {\n                            for (var i = 0; i < pacGlobal.proxy.length; i++) {\n                                var pp = new RegExp(pacGlobal.autoproxy_pattern[i]);\n                                var ahost = host;\n                                do {\n                                    if (pacGlobal.hosts[i].hasOwnProperty(ahost)\n                                        || (pacGlobal.autoproxy_pattern[i].length && pp.test(ahost))) {\n                                        return pacGlobal.proxy[i];\n                                    }\n                                    lastPos = ahost.indexOf('.') + 1;\n                                    ahost = ahost.slice(lastPos);\n                                } while (lastPos >= 1);\n                            }\n                            return "DIRECT";\n                        }\n                    }`}};chrome.proxy.settings.set({value:o,scope:"regular"},(function(){}))}else chrome.proxy.settings.clear({scope:"regular"})},_setNewTabUrl:function(){return"chrome://newtab/"},_getContainerName:function(e,t){}})})();