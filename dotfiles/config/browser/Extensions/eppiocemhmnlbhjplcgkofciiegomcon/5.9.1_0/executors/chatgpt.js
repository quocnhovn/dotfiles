(()=>{let W=null;const q=(()=>{const W=sessionStorage.getItem("bis_data");return null!==W?JSON.parse(W):null})(),k=q?.config?`${q.id}_t`:null,u=q?.config?.aiMessagesConfig?.CHATGPT||{},{PARSERS:O=[],CHATBOT_NAME:p="",AI_FEATURES:b}=u;window.addEventListener("message",(q=>{"CHATGPT_PROTECTION_STATUS_RESPONSE"===q.data?.type&&(W=q.data.content)})),window.postMessage({posdMessageId:"PANELOS_MESSAGE",posdHash:(Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)).substring(0,22),type:"CHATGPT_PROTECTION_STATUS",from:k,to:k.substring(0,k.length-2),content:""});const s=W=>{try{let q={posdMessageId:"PANELOS_MESSAGE",posdHash:(Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)).substring(0,22),type:"CHATGPT_DATA",from:k,to:k.substring(0,k.length-2),content:W};window.postMessage(q)}catch(W){}},y=function(W,q,k,u){try{if(E(W,q,u.RULES_GET_USER_VALUES),!W?.messageText)return null;R(W,u.MESSAGE_LIMIT||1e4),W.messageType="user",W.creationTime=k}catch(W){}},E=function(W,q,k){for(let u of k)u.PATH?.length?"payload"===u.SOURCE?W[u.NAME]=X.byPath(q,u.PATH):W[u.NAME]=X.byPath(null,u.PATH):u.REDUCE_PARAMS&&(W[u.NAME]=X.byReduce(q,u.REDUCE_PARAMS))},R=function(W,q){let k=W.messageText;"object"==typeof k&&k?.length&&(k=k.reduce(((W,q)=>"object"==typeof q?W:`${W} ${q}`),"")),W.messageText=k.trim().slice(0,q),W.messageLength=W.messageText.length},i=function(q,k,u,O,b){let i={chatbotName:p,messages:[]},h={},Q={};if(q?.body?.length){let k=JSON.parse(q.body);E(i,k,b.GENERAL_DATA.GET_BY_PATH),W||y(h,k,u,b.SENT_MESSAGE)}!function(W,q,k){if(!q?.length)return null;try{if(E(W,q,k.RULES_GET_SYSTEM_VALUES),!W?.messageText)return null;W.messageType="system",W.creationTime=null,R(W,k.MESSAGE_LIMIT||3e4)}catch(W){}}(Q,O,b.RECEIVED_MESSAGE),h?.messageText&&i.messages.push(h),Q?.messageText&&i.messages.push(Q),i.sessionId||(i.sessionId=k),i.messages.length&&setTimeout((()=>s(i)),0)},h=async function(W,q,k,u){const O=q.body.getReader(),p=new TextDecoder("utf-8");let b="",s=[],y="";try{for(;;){const{done:W,value:q}=await O.read();if(W)break;b+=p.decode(q,{stream:!0});let k=b.split("\n");for(let W=0;W<k.length;W++){const q=k[W].trim();if(q.startsWith("data:")&&u.RECEIVED_MESSAGE.INVALID_VALUES_TO_PARSE.some((W=>!q.includes(W)))){const W=q.slice(5).trim();try{s.push(JSON.parse(W))}catch(W){}}}y||(y=b.match(new RegExp(u.REGEXP_SESSION_ID_FROM_STREAM))?.groups?.sessionId),b=k[k.length-1]}}catch(W){}finally{i(W,y,k,s,u)}},Q={XMLHttpRequest:function(q){const k=self.fetch;self.fetch=async function(u,O={}){const R="string"==typeof u?u:u.url,i=O.method||"GET",Q=new Date,X=function(W,q,k){return new RegExp(k.REGEXP_URL_CHECK).test(W)&&q===k.REQUEST_METHOD}(R,i,q);let n;try{if(n=!X||!W||await function(W,q,k){return new Promise((u=>{if(!W?.body?.length)return void u(!0);let O,R=setTimeout((()=>{window.removeEventListener("message",O),u(!0)}),b?.DATA_PROTECTION?.MAX_DELAY_TIMEOUT||3e3),i={chatbotName:p,messages:[],startDelayTime:(new Date).getTime()},h={};try{let p=JSON.parse(W.body);E(i,p,k.GENERAL_DATA.GET_BY_PATH),y(h,p,q,k.SENT_MESSAGE),h?.messageText&&i.messages.push(h),O=function(W){switch(W.data?.type){case"CHATGPT_PROTECTION_CHECK_RESPONSE":case"CHATGPT_PROTECTION_NO_WARNINGS":clearTimeout(R),window.removeEventListener("message",O),u(W.data.result);break;case"CHATGPT_PROTECTION_CLEAR_TIMEOUT":clearTimeout(R)}}.bind(this),window.addEventListener("message",O),s(i)}catch(W){clearTimeout(R),u(!0)}}))}(O,Q,q),!n)throw new Error(b?.DATA_PROTECTION?.MESSAGE_ABORTED_REQUEST||"");const u=await k.apply(this,arguments),R=u.clone();return u.ok&&u.body instanceof ReadableStream&&X&&setTimeout(h.bind(this,O,R,Q,q),0),u}catch(W){return n?k.apply(this,arguments):new Promise(((q,k)=>{k(W.message)}))}}}},X={byReduce:(W,q)=>{const{KEY:k,CHECK_KEY:u,CHECK_VALUE:O,TYPE:p,RED_FLAG_PATH:b,RED_FLAG_VALUE:s,ALT_PATHS_TO_TEXT:y,ALT_TYPE:E,INVALID_TEXT_VALUES:R,FINISH_VALUE:i,ROLE_CHECK:h,CHECK_STREAM_COMPLETE:Q}=q;if(b?.length)for(let q of W){let W=q;for(let q=0;q<b.length;q++){const k=b[q];if(!W[k]){W=null;break}W=W[k]}if(W===s)return null}return W.reduce(((W,q,b,s)=>{if(!q.hasOwnProperty(k))return W;let n=JSON.stringify(q);if(n.includes(h))return W;if(n.includes(Q))return s.splice(b),W;if(typeof q[k]===p&&q[k]!==i)return W+=q[k];if(typeof q[k]===E&&!Array.isArray(q[k]))for(let u of y){let O=X.byPath(q[k],u);O&&!R.includes(O)&&(W+=typeof O===p&&O!==i?O:O?.join(""))}if(Array.isArray(q[k]))for(let b of q[k])b[u]===O&&b[k]&&typeof b[k]===p&&b[k]!==i&&(W+=b[k]);return W}),"")},byPath:(W,q)=>{let k=W||self;for(let W=0;W<q.length;W++){const u=q[W];if(!k.hasOwnProperty(u)){k=null;break}k=k[u]}return k}};!function(){for(let W of O)W.USE&&Q[W.TYPE](W)}()})();