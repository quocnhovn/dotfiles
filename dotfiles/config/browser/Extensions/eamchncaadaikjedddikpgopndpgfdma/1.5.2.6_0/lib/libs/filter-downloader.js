let FileDownloadWrapper=(()=>{"use strict";const s=e=>{e=new URL(e);return!["http:","https:"].includes(e.protocol)},t=(t,o)=>new Promise((n,i)=>{const e=new XMLHttpRequest;try{e.open("GET",t),e.setRequestHeader("Pragma","no-cache"),e.overrideMimeType(o),e.mozBackgroundRequest=!0,e.onload=function(){(e=>{200!==e.status&&0!==e.status&&i(new Error("Response status is invalid: "+e.status));const t=e.responseText||e.data;if(t||i(new Error("Response is empty")),!s(e.responseURL)){const r=e.getResponseHeader("Content-Type");r&&r.includes(o)||i(new Error(`Response content type should be: "${o}"`))}e=t.trim().split(/[\r\n]+/);n(e)})(e)},e.onerror=()=>i(new Error("Request error happened: "+(e.statusText||"status text empty"))),e.onabort=()=>i(new Error("Request was aborted with status text: "+e.statusText)),e.ontimeout=()=>i(new Error("Request timed out with status text: "+e.statusText)),e.send(null)}catch(e){i(e)}});return{getLocalFile:e=>t(e,"text/plain"),getExternalFile:e=>t(e,"text/plain")}})();void 0===FileDownloadWrapper&&(FileDownloadWrapper=require("./node/file-download-wrapper"));const FilterDownloader=(()=>{"use strict";const l="!#if",u="!#endif",n="!#include",i=/^([a-z]+:\/\/|\/\/)/i,a=(r,e)=>{const n=[];for(let t=e;t<r.length;t++){let e=r[t];if(e.startsWith(l))n.push(l);else if(e.startsWith(u)){if(!(0<n.length))return t;n.pop()}}return-1},d=(e,t)=>{if(!e)throw new Error("Invalid directives: Empty condition");if(!(e=>{let t=0;for(var r in e)if("("===e[r]?t++:")"===e[r]&&t--,t<0)return!1;return!(0<t)})(e=e.trim()))throw new Error("Invalid directives: Incorrect brackets: "+e);var r=e.lastIndexOf("(");if(-1!==r){var n=e.indexOf(")",r),i=e.substring(r+1,n),o=d(i,t),i=e.substring(0,r)+o+e.substring(n+1);return d(i,t)}let s;o=e.indexOf("&&"),n=e.indexOf("||"),i=e.indexOf("!");return s=-1!==n?d(e.substring(0,n-1),t)||d(e.substring(n+"||".length,e.length),t):-1!==o?d(e.substring(0,o-1),t)&&d(e.substring(o+"&&".length,e.length),t):0===i?!d(e.substring("!".length),t):((e,t)=>{if(!e)throw new Error("Invalid directives: Empty condition");e=e.trim();return"true"===e||t[e]})(e,t),s},c=(e,t)=>{e=e.substring(l.length).trim();return d(e,t)},p=(r,n)=>{let i=[];for(let t=0;t<r.length;t++){let e=r[t];if(0===e.indexOf(l)){var o,s=a(r,t+1);if(-1===s)throw new Error("Invalid directives: Condition end not found: "+e);c(e,n)&&(o=r.slice(t+1,s),i=i.concat(p(o,n))),t=s}else{if(0===e.indexOf(u))throw new Error("Invalid directives: Found unexpected condition end: "+e);i.push(e)}}return i},o=function(e,t,r){if(0!==e.indexOf(n))return Promise.resolve(e);e=decodeURI(e.substring(n.length).trim());return function(e,t){if(t&&i.test(e)){e=m(e).origin;if(e!==m(t).origin)throw new Error("Include url is rejected with origin: "+e)}}(e,t),f(e,t,r)},s=(e,t,r)=>{const n=[];for(var i of e)n.push(o(i,t,r));return Promise.all(n).then(e=>{let t=[];return e.forEach(function(e){Array.isArray(e)?t=t.concat(e):t.push(e)}),t})};const f=(e,t,r)=>(i.test(e)||i.test(t)?h:w)(e,t,r),h=(t,r,n)=>(!i.test(t)&&i.test(r)&&(t=r+"/"+t),FileDownloadWrapper.getExternalFile(t,r,n).then(e=>(r=g(t,null),s(e,r,n)))),w=(t,r,n)=>(r&&(t=r+"/"+t),r=g(t,r),FileDownloadWrapper.getLocalFile(t,r,n).then(e=>(r=g(t,null),s(e,r,n)))),g=(e,t)=>t||e.substring(0,e.lastIndexOf("/"));const m=t=>{if("undefined"!=typeof URL)return new URL(t);{let e=require("url").URL;return new e(t)}};return{compile:(e,t,r)=>{try{var n=p(e,r);return s(n,t,r)}catch(e){return Promise.reject(e)}},download:(t,r)=>{try{let e;return t&&i.test(t)&&(e=g(t)),f(t,e,r)}catch(e){return Promise.reject(e)}},resolveConditions:p,resolveIncludes:s,getFilterUrlOrigin:g}})();"undefined"!=typeof module&&module.exports&&(module.exports=FilterDownloader);