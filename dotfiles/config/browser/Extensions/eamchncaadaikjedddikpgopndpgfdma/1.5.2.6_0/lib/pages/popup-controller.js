const PopupController=function(){};function switchControlerBarStatus(e,t=!1){e&&(document.querySelector("#popup-header-buttons").style.display="flex",document.querySelector("#popup-header-buttons").style.filter="none",document.querySelector("#popup-header-buttons-disable").style.display="none",document.querySelector("h2").innerText="青少年上网保护"),e||t||(document.querySelector("#popup-header-buttons").style.display="none",document.querySelector("#popup-header-buttons").style.filter="none",document.querySelector("#popup-header-buttons-disable").style.display="none",document.querySelector("h2").innerText="青少年上网保护"),!e&&t&&(document.querySelector("#popup-header-buttons").style.filter="grayscale(100%)",document.querySelector("#popup-header-buttons-disable").style.display="block",document.querySelector("h2").innerText="青少年上网保护")}PopupController.prototype={render(e,t){this.tabInfo=e,this.options=t||{},this._renderPopup(e),this._bindActions(),this.afterRender()},resizePopupWindow(){var e=document.querySelector(".widget-popup"),t=e.offsetWidth,e=e.offsetHeight;popupPage.resizePopup(t,e)},afterRender(){},addWhiteListDomain(e){popupPage.sendMessage({type:"addWhiteListDomainPopup",url:e})},removeWhiteListDomain(e){popupPage.sendMessage({type:"removeWhiteListDomainPopup",url:e})},changeApplicationFilteringDisabled(e){popupPage.sendMessage({type:"changeApplicationFilteringDisabled",disabled:e})},sendFeedback(e,t,s){popupPage.sendMessage({type:"sendFeedback",url:e,topic:t,comment:s})},openSiteReportTab(e){popupPage.sendMessage({type:"openSiteReportTab",url:e})},openAbuseTab(e){popupPage.sendMessage({type:"openAbuseTab",url:e})},openSettingsTab(){popupPage.sendMessage({type:"openSettingsTab"})},openAssistantInTab(){popupPage.sendMessage({type:"openAssistant"})},openFilteringLog(e){popupPage.sendMessage({type:"openFilteringLog",tabId:e})},resetBlockedAdsCount(){popupPage.sendMessage({type:"resetBlockedAdsCount"})},openLink(e){popupPage.sendMessage({type:"openTab",url:e})},updateTotalBlocked(e){var t,s,i,a;e&&({BlockedTab:s,allHistoryBlocked:t}=this.tabInfo=e,{nsfw:a,adblock:i,private:e}=s,(s=document.querySelector(".widget-popup .blocked-adblock"))&&i18n.translateElement(s,"popup_tab_blocked",[this._formatNumber(i||0)]),(i=document.querySelector(".widget-popup .blocked-private"))&&i18n.translateElement(i,"popup_tab_blocked_all",[this._formatNumber(e||0)]),(e=document.querySelector(".widget-popup .blocked-nsfw"))&&i18n.translateElement(e,"popup_tab_blocked",[this._formatNumber(a||0)]),(a=document.querySelector(".widget-popup .blocked-all"))&&i18n.translateElement(a,"popup_tab_blocked_all",[this._formatNumber(t||0)]))},_renderPopup(e){const t=document.querySelector(".widget-popup"),s=document.querySelector("#filtering-default-control-template > div.control-buttons"),i=document.querySelector(".widget-popup__header");for(;i.firstChild;)i.removeChild(i.firstChild);e.allowAppeptableAdsDisable?(document.getElementById("allow-appeptable-ads").style.display="none",document.getElementById("allow-appeptable-ads-line").style.display="none"):(document.getElementById("allow-appeptable-ads").style.display="block",document.getElementById("allow-appeptable-ads-line").style.display="block");const a=t.querySelector(".footer");for(;a.firstChild;)a.removeChild(a.firstChild);const o=t.querySelector(".tabstack"),n=t.querySelector(".tab-main");for(;n.firstChild;)n.removeChild(n.firstChild);const p=t.querySelector(".tab-statistics");for(;p.firstChild;)p.removeChild(p.firstChild);if(o.setAttribute("class","tabstack"),t.setAttribute("class","widget-popup"),e.applicationFilteringDisabled)o.classList.add("status-paused"),t.classList.add("status-paused"),s.setAttribute("aria-checked","false");else if(e.applicationAvailable)if(e.canAddRemoveRule)if(e.documentWhiteListed){const r=document.querySelectorAll(".is-show-whitelist");r.forEach(e=>{e.style.display="block"}),o.classList.add("status-whiteList"),t.classList.add("status-cross"),s.setAttribute("aria-checked","false")}else o.classList.add("status-checkmark"),t.classList.add("status-checkmark"),s.setAttribute("aria-checked","true");else o.classList.add("status-error"),t.classList.add("status-checkmark");else o.classList.add("status-inner"),t.classList.add("status-checkmark"),s.setAttribute("aria-hidden","true");this.filteringHeader=this._getTemplate("filtering-header-template"),this.filteringDefaultHeader=this._getTemplate("filtering-default-header-template"),this.filteringControlDefault=this._getTemplate("filtering-default-control-template"),this.filteringStatusText=this._getTemplate("filtering-status-template"),this.filteringMessageText=this._getTemplate("filtering-message-template"),this.filteringStatisticsTemplate=this._getTemplate("filtering-statistics-template"),this.footerDefault=this._getTemplate("footer-default-template"),this.notification=this._getTemplate("notification-template"),this.animatedNotification=this._getTemplate("animated-notification-template"),this._renderHeader(i,e),this._renderNotificationBlock(o,e,this.options),this._renderFilteringControls(n),this._renderStatus(n,e),this._renderMain(n,e),this._renderMessage(n,e),this._renderFooter(a,e,this.options),this._renderAnimatedNotification(t,e,this.options)},_getTemplate(e){return document.querySelector("#"+e).cloneNode(!0)},_appendTemplate(t,e){[].slice.call(e.childNodes).forEach(e=>{t.appendChild(e.cloneNode(!0))})},_renderHeader(e){var t=this.filteringHeader;this._appendTemplate(e,t)},_renderAnimatedNotification(e,t,s){s=s.notification;if(s&&"animated"===s.type&&s.text){if(s.text.title){const i=this.animatedNotification.querySelector(".holiday-notify__title");i.innerText=s.text.title}if(s.text.btn){const a=this.animatedNotification.querySelector(".holiday-notify__btn");a.innerText=s.text.btn}this._appendTemplate(e,this.animatedNotification),popupPage.sendMessage({type:"setNotificationViewed",withDelay:!0})}},_renderNotificationBlock(e,t,s){const i=s["notification"];if(i&&"simple"===i.type){var{bgColor:a,textColor:o,text:s}=i;if(s){const n=this.notification.querySelector(".openNotificationLink");if(n.innerHTML=s,a&&o){const i=this.notification.querySelector(".notice");i.setAttribute("style",`background-color: ${a}; color: `+o)}this._appendTemplate(e,this.notification),popupPage.sendMessage({type:"setNotificationViewed",withDelay:!0})}}},_renderMain(e,t){var s=this.filteringDefaultHeader;setTimeout(()=>{this.updateTotalBlocked(t)},100),this._appendTemplate(e,s)},_renderFilteringControls(e){var t=this.filteringControlDefault;this._appendTemplate(e,t)},_renderStatus(e,t){const s=this.filteringStatusText;let i="";i=t.applicationAvailable?t.documentWhiteListed&&!t.userWhiteListed?"":t.applicationFilteringDisabled?"popup_site_filtering_state_paused":t.documentWhiteListed?"popup_site_filtering_state_whiteList_disabled":"popup_site_filtering_state_enabled":"popup_site_filtering_state_secure_page";const a=s.querySelector(".status");i?i18n.translateElement(a,i):a.classList.add("status--hide");const o=s.querySelector(".current-site");t.applicationAvailable?o.textContent=t.domainName||t.url:o.textContent=t.url,this._appendTemplate(e,s)},_renderMessage(e,t){let s;t.applicationAvailable?t.documentWhiteListed&&!t.userWhiteListed&&(s="popup_site_exception_info"):s="";t=this.filteringMessageText;s&&(i18n.translateElement(t.childNodes[1],s),this._appendTemplate(e,t))},_selectRequestTypesStatsData(e,t){let s={};switch(t){case"day":s=e.lastMonth[e.lastMonth.length-1];break;case"week":for(var i=0;i<e.lastWeek.length;i++)for(o in a=e.lastWeek[i])a[o]&&(s[o]=(s[o]||0)+a[o]);break;case"month":s=e.lastYear[e.lastYear.length-1];break;case"year":for(var a,o,i=0;i<e.lastYear.length;i++)for(o in a=e.lastYear[i])a[o]&&(s[o]=(s[o]||0)+a[o])}return s},_selectRequestsStatsData(e,t,s){const i=[];switch(t){case"day":e.today.forEach(e=>{i.push(e[s])});break;case"week":e.lastWeek.forEach(e=>{i.push(e[s])});break;case"month":e.lastMonth.forEach(e=>{i.push(e[s])});break;case"year":e.lastYear.forEach(e=>{i.push(e[s])})}return i.map(e=>void 0===e?0:e)},DAYS_OF_WEEK:function(){return this.DAYS_OF_WEEK||[i18n.getMessage("popup_statistics_week_days_mon"),i18n.getMessage("popup_statistics_week_days_tue"),i18n.getMessage("popup_statistics_week_days_wed"),i18n.getMessage("popup_statistics_week_days_thu"),i18n.getMessage("popup_statistics_week_days_fri"),i18n.getMessage("popup_statistics_week_days_sat"),i18n.getMessage("popup_statistics_week_days_sun")]}(),_dayOfWeekAsString(e){return this.DAYS_OF_WEEK[e]},MONTHS_OF_YEAR:function(){return this.MONTHS_OF_YEAR||[i18n.getMessage("popup_statistics_months_jan"),i18n.getMessage("popup_statistics_months_feb"),i18n.getMessage("popup_statistics_months_mar"),i18n.getMessage("popup_statistics_months_apr"),i18n.getMessage("popup_statistics_months_may"),i18n.getMessage("popup_statistics_months_jun"),i18n.getMessage("popup_statistics_months_jul"),i18n.getMessage("popup_statistics_months_aug"),i18n.getMessage("popup_statistics_months_sep"),i18n.getMessage("popup_statistics_months_oct"),i18n.getMessage("popup_statistics_months_nov"),i18n.getMessage("popup_statistics_months_dec")]}(),_monthsAsString(e){return this.MONTHS_OF_YEAR[e]},_getCategoriesLines(t,e){const s=new Date;var i=s.getDay(),a=s.getMonth(),o=new Date(s.getFullYear(),s.getMonth(),0).getDate();let n=[];const p=[];switch(e){case"day":for(let e=1;e<25;e+=1)if(e%3==0){const r=(e+s.getHours())%24;n.push(r.toString()),p.push({value:e-1})}else n.push("");break;case"week":for(let e=0;e<7;e+=1)n.push(this._dayOfWeekAsString((i+e)%7)),p.push({value:e});break;case"month":for(let e=0;e<31;e+=1)if(e%3==0){const l=(e+s.getDate())%o+1;n.push(l.toString()),p.push({value:e})}else n.push("");break;case"year":for(let e=0;e<13;e+=1)n.push(this._monthsAsString((a+e)%12)),n=n.slice(-t.length),p.push({value:e})}return{categories:n,lines:p}},_renderRequestsGraphs(e,t,s){e=this._selectRequestsStatsData(e,t,s),s=this._getCategoriesLines(e,t),t=s.categories,s=s.lines;c3.generate({size:{height:230},data:{columns:[["data1"].concat(e)],types:{data1:"area-spline"},colors:{data1:"url(#grad1)"}},padding:{left:15,right:15},axis:{x:{show:!0,type:"category",categories:t,tick:{outer:!1,multiline:!1}},y:{show:!1}},legend:{show:!1},grid:{x:{lines:s},focus:{show:!0}},spline:{interpolation:{type:"basis"}},point:{show:!1},tooltip:{position(e,t,s,i){const a=document.querySelector("#chart");var o=i.getBoundingClientRect(),o=o.left+o.width/2-a.querySelector(".chart__tooltip").clientWidth/2;return{top:d3.mouse(i)[1]-50,left:o}},contents(e){e=e[0].value;return`<div id="tooltip" class="chart__tooltip">${e}</div>`}},oninit(){this.svg[0][0].getElementsByTagName("defs")[0].innerHTML+='<linearGradient id="grad1" x1="50%" y1="0%" x2="50%" y2="100%">  <stop offset="0%" style="stop-color:#73BE66;stop-opacity:1" />  <stop offset="23%" style="stop-color:#6DBE85;stop-opacity:1" />  <stop offset="100%" style="stop-color:#65BDA8;stop-opacity:1" /></linearGradient>'}})},_renderAnalyticsBlock(e,t){const s=this._selectRequestTypesStatsData(e,t),i=document.querySelector("#analytics-blocked-types-values");for(;i.firstChild;)i.removeChild(i.firstChild);const a=e["blockedGroups"];a.forEach(e=>{var t=s[e.groupId];t&&(t=htmlToElement(`
                <li>
                    <span class="key" tabindex="0">${e.groupName}</span>
                    <span class="value" tabindex="0">${t}</span>
                </li>
            `),i.appendChild(t))})},_renderStatsGraphs(e,t,s){this._renderRequestsGraphs(e,t,s),this._renderAnalyticsBlock(e,t)},_renderStatsBlock(e){const t=document.querySelector(".statistics-select-time").value,s=document.querySelector(".statistics-select-type").value;if(e)this._renderStatsGraphs(e,t,s);else{const i=this;popupPage.sendMessage({type:"getStatisticsData"},e=>{i._renderStatsGraphs(e.stats,t,s)})}},_renderBlockedGroups(e,t){var s=document.querySelector(".statistics-select-time").value;const i=e.querySelector(".statistics-select-type"),a=this._selectRequestTypesStatsData(t,s),o=e=>`<option value="${e.groupId}">${e.groupName}</option>`,n=t.blockedGroups.filter(e=>a[e.groupId]);0!==n.length?n.forEach(e=>{i.insertAdjacentHTML("beforeend",o(e))}):([t]=t.blockedGroups.filter(({groupId:e})=>"total"===e),i.insertAdjacentHTML("beforeend",o(t)))},_renderStats(t){var e=this.filteringStatisticsTemplate;this._appendTemplate(t,e);const s=this;popupPage.sendMessage({type:"getStatisticsData"},e=>{e=e.stats;s._renderBlockedGroups(t,e),s._renderStatsBlock(e)})},_renderActions(e,t){const s=document.createElement("div");if(s.classList.add("actions"),t.applicationFilteringDisabled||t.documentWhiteListed,!t.applicationAvailable){const i=[".openAssistant",".siteReport",".openAbuse"];i.forEach(e=>{const t=s.querySelector(e);t.classList.add("action_disabled"),t.setAttribute("aria-hidden","true")})}e.appendChild(s)},_renderFooter(e,t,s){const i=this["footerDefault"];i.querySelector(".popup-get-premium");const a=i.querySelector(".popup-footer"),o=i.querySelector(".footer__title");if(a&&o)if(s.isEdgeBrowser){a.innerHTML=`<div class="popup-footer--edge">© 2009-${(new Date).getFullYear()} AdGuard Software Ltd</div>`;const n=i.querySelector(".platforms");n&&(n.style.display="none")}else o.setAttribute("title",i18n.getMessage("popup_adguard_footer_title"));this._appendTemplate(e,i)},_bindAction(e,t,s,i){const a=[].slice.call(e.querySelectorAll(t));!a||a.length<=0||a.forEach(e=>e.addEventListener(s,i))},_bindActions(){const s=document.querySelector(".widget-popup"),i=this;this._bindAction(s,".siteReport","click",e=>{e.preventDefault(),i.tabInfo.applicationAvailable&&(i.openSiteReportTab(i.tabInfo.url),popupPage.closePopup())}),this._bindAction(s,".openSettings","click",e=>{e.preventDefault(),i.openSettingsTab(),popupPage.closePopup()}),this._bindAction(s,".openAssistant","click",e=>{e.preventDefault(),i.tabInfo.applicationAvailable&&(i.openAssistantInTab(),popupPage.closePopup())}),this._bindAction(s,".openNotificationLink","click",e=>{e.preventDefault();e=i.options.notification.url;e&&(i.openLink(e+"&from=popup"),popupPage.sendMessage({type:"setNotificationViewed",withDelay:!1}),popupPage.closePopup())}),this._bindAction(s,".closeNotification","click",e=>{e.preventDefault();const t=s.querySelector("#popup-notification");t&&(t.style.display="none",popupPage.sendMessage({type:"setNotificationViewed",withDelay:!1}))}),this._bindAction(s,".holiday-notify__btn","click",e=>{e.preventDefault();e=i.options.notification.url;e&&(i.openLink(e),popupPage.sendMessage({type:"setNotificationViewed",withDelay:!1}),popupPage.closePopup())}),this._bindAction(s,".holiday-notify__close","click",e=>{e.preventDefault();const t=s.querySelector(".holiday-notify");t&&(t.classList.add("holiday-notify--close"),popupPage.sendMessage({type:"setNotificationViewed",withDelay:!1}))});const t=()=>{const e=s.querySelector(".popup-get-premium"),t=s.querySelector(".popup-footer");e&&(e.style.display="none",t.style.display="block",popupPage.sendMessage({type:"disableGetPremiumNotification"}))};function a(e){const t=i["tabInfo"];t.applicationFilteringDisabled!==e&&(i.changeApplicationFilteringDisabled(e),t.applicationFilteringDisabled=e,t.totalBlockedTab=0,t.privatyed=0,popupPage.sendMessage({type:"getTabInfoForPopup"},e=>{e.frameInfo.totalBlockedTab=0,e.frameInfo.privatyed=0,i._renderPopup(e.frameInfo),i._bindActions(),i.resizePopupWindow()}))}this._bindAction(s,".popup_get_premium_close","click",e=>{e.preventDefault(),t()}),this._bindAction(s,".popup-get-premium","click",()=>{t()}),this._bindAction(s,".openFilteringLog","click",e=>{e.preventDefault(),i.openFilteringLog(),popupPage.closePopup()}),this._bindAction(s,".resetStats","click",e=>{e.preventDefault(),i.resetBlockedAdsCount(),s.querySelector(".w-popup-filter-title-blocked-all").textContent="0"}),this._bindAction(s,".openLink","click",e=>{e.preventDefault(),i.openLink(e.currentTarget.href),popupPage.closePopup()}),this._bindAction(s,".openAbuse","click",e=>{e.preventDefault(),i.tabInfo.applicationAvailable&&(i.openAbuseTab(i.tabInfo.url),popupPage.closePopup())}),this._bindAction(s,".footer-report","click",e=>{popupPage.sendMessage({type:"uosReport"})}),this._bindAction(s,".blackBtn","click",e=>{const t=i["tabInfo"];if(popupPage.sendMessage({type:"uosAddBlackList",url:t.url}),t.documentWhiteListed){t.documentWhiteListed=null,t.userWhiteListed=!1,t.totalBlockedTab=0,i.removeWhiteListDomain(t.url),i._renderPopup(t),i._bindActions(),i.resizePopupWindow();const s=document.querySelectorAll(".is-show-whitelist");s.forEach(e=>{e.style.display="none"})}}),this._bindAction(s,".changeDocumentWhiteListed","click",e=>{e.preventDefault();const t=i["tabInfo"];if(t.applicationAvailable&&!t.applicationFilteringDisabled&&t.canAddRemoveRule){let e=t.documentWhiteListed;e=e?(i.removeWhiteListDomain(t.url),!1):(i.addWhiteListDomain(t.url),!0),t.documentWhiteListed=e,t.userWhiteListed=e,t.totalBlockedTab=0,i._renderPopup(t),i._bindActions(),i.resizePopupWindow()}});const e=[].slice.call(document.querySelectorAll(".changeProtectionStateDisable"));e.forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),a(!0)})});const o=[].slice.call(document.querySelectorAll(".changeProtectionStateEnable"));o.forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),a(!1)})}),this._bindAction(s,".statistics-select-time","change",()=>{i._renderStatsBlock()}),this._bindAction(s,".statistics-select-type","change",()=>{i._renderStatsBlock()})},_formatNumber(e){return 6<String(e).length?String(e)[0]+"E"+String(e).length:e.toLocaleString()}},function(){const a=new PopupController;a.afterRender=function(){setTimeout(()=>{a.resizePopupWindow()},10)},chrome.storage.local.get("adguard-settings",e=>{e=e["adguard-settings"].appName;document.querySelector(".widget-popup__header-logo").innerHTML=e||adguard.uoschannel.name}),document.addEventListener("resizePopup",()=>{a.resizePopupWindow()}),popupPage.sendMessage({type:"getTabInfoForPopup"},e=>{var t=()=>{a.render(e.frameInfo,e.options)};(document.attachEvent?"complete"===document.readyState:"loading"!==document.readyState)?t():document.addEventListener("DOMContentLoaded",t)}),2==adguard.uoschannel.id&&popupPage.sendMessage({type:"getUserInfo"},e=>{e&&Object.prototype.hasOwnProperty.call(e,"userType")&&(e=e["userType"],e&&switchControlerBarStatus(1==e))}),1==adguard.uoschannel.id&&popupPage.sendMessage({type:"getGreenInternetEnable"},e=>{switchControlerBarStatus(1!=e,!0)}),popupPage.onMessage.addListener(e=>{switch(e.type){case"appNameChange":document.querySelector(".widget-popup__header-logo").innerHTML=e.appName;break;case"changeUserSetting":"allow-appeptable-ads-disable"===e.key&&(e.value?document.getElementById("allow-appeptable-ads").style.display="none":document.getElementById("allow-appeptable-ads").style.display="flex");break;case"updateTotalBlocked":var t=e["tabInfo"];a.updateTotalBlocked(t);break;case"reportSuccess":const i=document.getElementById("user-report-success");i.className="user-report-success-show",i.children[0].children[1].innerText=e.title,setTimeout(()=>{i.className="user-report-success-hide"},3e3),setTimeout(()=>{chrome.tabs.create({url:"https://www.12377.cn/"})},500);break;case"userInfoChange":2==adguard.uoschannel.id&&(s=e.userInfo["userType"],switchControlerBarStatus(1==s));break;case"greenInternetEnableChange":var s;1==adguard.uoschannel.id&&(s=e["enable"],switchControlerBarStatus(1!=s,!0))}})}();