!function(o){"use strict";function e(e){this.requestCache=Object.create(null),this.requestCacheSize=0,this.requestCacheMaxSize=e,this.searchRequestCache=function(e,t,i){e=this.requestCache[e];if(!e)return null;i=e[i];return i&&i[1]===t?i:null},this.saveResultToCache=function(e,t,i,s){this.requestCacheSize>this.requestCacheMaxSize&&this.clearRequestCache(),this.requestCache[e]||(this.requestCache[e]=Object.create(null),this.requestCacheSize+=1),this.requestCache[e][s]=[t,i]},this.clearRequestCache=function(){0!==this.requestCacheSize&&(this.requestCache=Object.create(null),this.requestCacheSize=0)}}function t(){this.badFilterRules={},this.urlBlockingFilter=new o.rules.UrlFilter([],this.badFilterRules),this.urlWhiteFilter=new o.rules.UrlFilter([],this.badFilterRules),this.cssFilter=new o.rules.CssFilter,this.scriptFilter=new o.rules.ScriptFilter,this.cspFilter=new o.rules.CspFilter([],this.badFilterRules),this.cookieFilter=new o.rules.CookieFilter,this.stealthFilter=new o.rules.UrlFilter([],this.badFilterRules),this.replaceFilter=new o.rules.ReplaceFilter([],this.badFilterRules),this.removeparamFilter=new o.rules.RemoveparamFilter([],this.badFilterRules),this.contentFilter=new o.rules.ContentFilter,this.rulesCount=0,this.urlBlockingCache=new e(this.requestCacheMaxSize),this.urlExceptionsCache=new e(this.requestCacheMaxSize)}t.prototype={requestCacheMaxSize:1e3,addRules(t){if(t)for(let e=0;e<t.length;e+=1)this.addRule(t[e])},addRule(e){if(null!==e&&e.ruleText){if(e instanceof o.rules.UrlFilterRule){if("function"==typeof e.isIgnored&&e.isIgnored())return void o.console.debug(`FilterRule with $extension modifier was omitted. Rule text: "${e.ruleText}"`);e.isCspRule()&&!e.isBadFilter()?this.cspFilter.addRule(e):e.isCookieRule()?this.cookieFilter.addRule(e):e.isStealthRule()&&!e.isBadFilter()?this.stealthFilter.addRule(e):e.isReplaceRule()&&!e.isBadFilter()?this.replaceFilter.addRule(e):e.isRemoveparamRule()&&!e.isBadFilter()?this.removeparamFilter.addRule(e):e.isBadFilter()?this.badFilterRules[e.badFilter]=e:(e.whiteListRule?this.urlWhiteFilter:this.urlBlockingFilter).addRule(e)}else e instanceof o.rules.CssFilterRule?this.cssFilter.addRule(e):e instanceof o.rules.ScriptFilterRule||e instanceof o.rules.ScriptletRule?this.scriptFilter.addRule(e):e instanceof o.rules.CompositeRule?e.rules.forEach(this.addRule.bind(this)):e instanceof o.rules.ContentFilterRule&&this.contentFilter.addRule(e);this.rulesCount++,this.urlBlockingCache.clearRequestCache(),this.urlExceptionsCache.clearRequestCache()}else o.console.error("FilterRule must not be null")},removeRule(e){null!==e?(e instanceof o.rules.UrlFilterRule?e.isCspRule()?this.cspFilter.removeRule(e):e.isCookieRule()?this.cookieFilter.removeRule(e):e.isStealthRule()?this.stealthFilter.removeRule(e):e.isBadFilter()?delete this.badFilterRules[e.badFilter]:(e.whiteListRule?this.urlWhiteFilter:this.urlBlockingFilter).removeRule(e):e instanceof o.rules.CssFilterRule?this.cssFilter.removeRule(e):e instanceof o.rules.ScriptFilterRule||e instanceof o.rules.ScriptletRule?this.scriptFilter.removeRule(e):e instanceof o.rules.CompositeRule?e.rules.forEach(this.removeRule.bind(this)):e instanceof o.rules.ContentFilterRule&&this.contentFilter.removeRule(e),--this.rulesCount,this.urlBlockingCache.clearRequestCache(),this.urlExceptionsCache.clearRequestCache()):o.console.error("FilterRule must not be null")},getRules(){let e=[];e=e.concat(this.urlWhiteFilter.getRules()),e=e.concat(this.urlBlockingFilter.getRules()),e=e.concat(this.cssFilter.getRules()),e=e.concat(this.scriptFilter.getRules()),e=e.concat(this.cspFilter.getRules()),e=e.concat(this.cookieFilter.getRules()),e=e.concat(this.stealthFilter.getRules());for(const t in this.badFilterRules)e.push(this.badFilterRules[t]);return e},getSelectorsForUrl(e,t){var i=o.utils.url.getHost(e),e=o.rules.CssFilter["CSS_INJECTION_ONLY"];return(t&e)===e||!o.webRequestService.isCollectingCosmeticRulesHits()?this.cssFilter.buildCss(i,t):this.cssFilter.buildCssHits(i,t)},getScriptsForUrl(e,t){e=o.utils.url.getHost(e),t={debug:t,domainName:e,engine:"extension",version:o.app&&o.app.getVersion&&o.app.getVersion()};return this.scriptFilter.buildScript(e,t)},getScriptsStringForUrl(t,i){var e=o.filteringLog&&o.filteringLog.isOpen();const s=this.getScriptsForUrl(t,e);o.utils.browser.isFirefoxBrowser();const l=o.utils.browser.isOperaBrowser(),r=s.filter(e=>"local"===e.scriptSource||"remote"===e.scriptSource&&!l);if(e){const u=o.utils.url.getHost(t);s.forEach(e=>{(e.rule instanceof o.rules.ScriptletRule||e.rule.isDomainSpecific(u))&&o.filteringLog.addScriptInjectionEvent(i,t,o.RequestTypes.DOCUMENT,e.rule)})}return`
            (function () {
                try {
                    ${r.map(e=>e.script).join("\r\n")}
                } catch (ex) {
                    console.error('Error executing AG js: ' + ex);
                }
            })();
            `},findWhiteListRule(e,t,i){var s=o.utils.url.getHost(t),l=o.utils.url.isThirdPartyRequest(e,t),t=this.urlExceptionsCache.searchRequestCache(e,s,i);if(t)return t[0];l=this._checkWhiteList(e,s,i,l);return this.urlExceptionsCache.saveResultToCache(e,l,s,i),l},findStealthWhiteListRule(e,t,i){var s=o.utils.url.getHost(t),l=o.utils.url.isThirdPartyRequest(e,t);let r=this.stealthFilter.isFiltered(t,s,i,l);return r=r||this.stealthFilter.isFiltered(e,s,i,l),r},findRuleForRequest(e,t,i,s){var l=o.utils.url.getHost(t),r=o.utils.url.isThirdPartyRequest(e,t),t=this.urlBlockingCache.searchRequestCache(e,l,i);if(t)return t[0];s=this._findRuleForRequest(e,l,i,r,s);return this.urlBlockingCache.saveResultToCache(e,s,l,i),s},getContentRulesForUrl(e){e=o.utils.url.getHost(e);return this.contentFilter.getRulesForDomain(e)},getMatchedElementsForContentRules(e,t){return this.contentFilter.getMatchedElementsForRules(e,t)},findCspRules(e,t,i){var s=o.utils.url.getHost(t),t=o.utils.url.isThirdPartyRequest(e,t);return this.cspFilter.findCspRules(e,s,t,i)},findReplaceRules(e,t,i){var s=o.utils.url.getHost(t),t=o.utils.url.isThirdPartyRequest(e,t);return this.replaceFilter.findReplaceRules(e,s,t,i)},findRemoveparamRules(e,t,i){var s=o.utils.url.getHost(t),t=o.utils.url.isThirdPartyRequest(e,t);return this.removeparamFilter.findRemoveparamRules(e,s,t,i)},findCookieRules(e,t,i){var s=o.utils.url.getHost(t),t=o.utils.url.isThirdPartyRequest(e,t);return this.cookieFilter.findCookieRules(e,s,t,i)},_checkWhiteList(e,t,i,s){return null!==this.urlWhiteFilter&&e?this.urlWhiteFilter.isFiltered(e,t,i,s):null},_checkUrlBlockingList(e,t,i,s,l){return null!==this.urlBlockingFilter&&e?this.urlBlockingFilter.isFiltered(e,t,i,s,!l):null},_findRuleForRequest(e,t,i,s,l){o.console.debug("Filtering http request for url: {0}, document: {1}, requestType: {2}",e,t,i);var r=this._checkWhiteList(e,t,i,s),u=!l||!l.isGenericBlock(),n=!l||!l.isUrlBlock(),s=this._checkUrlBlockingList(e,t,i,s,u);return!r||!r.isImportant&&s&&s.isImportant?(u&&n||o.console.debug("White list rule {0} found for document: {1}",l.ruleText,t),n?(s&&o.console.debug("Black list rule {0} found for url: {1}, document: {2}, requestType: {3}",s.ruleText,e,t,i),s):l):(o.console.debug("White list rule found {0} for url: {1} document: {2}, requestType: {3}",r.ruleText,e,t,i),r)}},o.RequestFilter=t}(adguard);