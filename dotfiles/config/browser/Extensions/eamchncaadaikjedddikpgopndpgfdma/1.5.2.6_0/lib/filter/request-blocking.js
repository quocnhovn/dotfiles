adguard.webRequestService=function(R){"use strict";function i(e){return e?e&&R.settings.collectHitsCount()&&!R.frames.isIncognitoTab(e):R.settings.collectHitsCount()}const c=R.utils.channels.newChannel();var a=function(e){return e&&!e.whiteListRule&&!e.getReplace()&&!e.isRedirectRule()};const f=function(e){return e&&!e.whiteListRule&&e.isBlockPopups()};function u(e,t,r,s){if(R.frames.isTabProtectionDisabled(e))return null;let i;return i=e.tabId===R.BACKGROUND_TAB_ID?R.whitelist.findWhiteListRule(r):R.frames.getFrameWhiteListRule(e),i&&i.isDocumentWhiteList()?i:(i=i||R.requestFilter.findWhiteListRule(t,r,R.RequestTypes.DOCUMENT),R.requestFilter.findRuleForRequest(t,r,s,i))}function l(e,t,r,s,i){if(i&&!i.whiteListRule){var l=a(i),u=f(i),n=!!i.getReplace();if(l&&s===R.RequestTypes.DOCUMENT&&(i.isDocumentRule()||u||(i=null)),i=(i=n?null:i)&&i.isRemoveparamRule()?null:i){R.listeners.notifyListenersAsync(R.listeners.ADS_BLOCKED,{...i,referrerUrl:r},e,1);const o={tabId:e.tabId,requestUrl:t,referrerUrl:r,requestType:s};o.rule=i.ruleText,o.filterId=i.filterId,c.notify(o)}}return i}return{processGetSelectorsAndScripts:function(e,t,r,s){const i=Object.create(null);if(!e)return i;if(!R.requestFilter.isReady())return i.requestFilterReady=!1,i;if(R.frames.isTabProtectionDisabled(e))return i;let l=R.frames.getFrameWhiteListRule(e);l||(u=R.frames.getMainFrameUrl(e),l=R.requestFilter.findWhiteListRule(t,u,R.RequestTypes.DOCUMENT));var u,n=R.rules["CssFilter"],o=l&&l.isElemhide(),c=l&&l.isGenericHide();void 0===r&&void 0===s?(u=R.prefs.features["canUseInsertCSSAndExecuteScript"],s=!u,o||(r=n.RETRIEVE_EXTCSS,u||(r+=n.RETRIEVE_TRADITIONAL_CSS),c&&(r+=n.GENERIC_HIDE_APPLIED))):!o&&c&&(r+=n.GENERIC_HIDE_APPLIED);n=!o&&0!=(r&n.RETRIEVE_TRADITIONAL_CSS+n.RETRIEVE_EXTCSS);if(R.frames.isTabWhiteListed(e))return i;n&&(i.collapseAllElements=R.requestFilter.shouldCollapseAllElements(),i.selectors=R.requestFilter.getSelectorsForUrl(t,r)),s&&(l&&l.isJsInject()||(i.scripts=R.requestFilter.getScriptsStringForUrl(t,e))),i.collectRulesHits=!o&&R.webRequestService.isCollectingCosmeticRulesHits(e);e=R.stealthService.getDomSignalScript();return e&&(i.scripts=i.scripts?i.scripts+`
`+e:e),i},checkPageScriptWrapperRequest:function(e,t,r,s){if(!e)return!1;var i=u(e,t,r,s),i=l(e,t,r,s,i);return R.requestContextStorage.recordEmulated(t,r,s,e,i),a(i)},processShouldCollapse:function(e,t,r,s){if(!e)return!1;s=u(e,t,r,s);return a(s)},processShouldCollapseMany:function(t,r,s){if(!t)return s;for(let e=0;e<s.length;e++){const l=s[e];var i=u(t,l.elementUrl,r,l.requestType);l.collapse=a(i)}return s},isRequestBlockedByRule:a,isPopupBlockedByRule:f,getBlockedResponseByRule:function(e,t,r){if(a(e)){if((t===R.RequestTypes.DOCUMENT||t===R.RequestTypes.SUBDOCUMENT)&&e.isDocumentRule()){r=R.rules.documentFilterService.getDocumentBlockPageUrl(r,e.ruleText);return r?{documentBlockedPage:r}:null}if(t!==R.RequestTypes.DOCUMENT)return{cancel:!0}}else if(e&&!e.whiteListRule&&e.isRedirectRule()){const s=e.getRedirect();return{redirectUrl:s.getRedirectUrl()}}return null},getRuleForRequest:u,getCspRules:function(e,t,r,s){if(R.frames.shouldStopRequestProcess(e))return null;const i=R.requestFilter.findWhiteListRule(t,r,R.RequestTypes.DOCUMENT);return i&&i.isUrlBlock()?null:R.requestFilter.getCspRules(t,r,s)},getCookieRules:(e,t,r,s)=>{if(R.frames.shouldStopRequestProcess(e))return null;const i=R.requestFilter.findWhiteListRule(t,r,R.RequestTypes.DOCUMENT);return i&&i.isDocumentWhiteList()?null:R.requestFilter.getCookieRules(t,r,s)},getContentRules:function(e,t){if(R.frames.shouldStopRequestProcess(e))return null;const r=R.requestFilter.findWhiteListRule(t,t,R.RequestTypes.DOCUMENT);return r&&r.isContent()?null:R.requestFilter.getContentRulesForUrl(t)},getReplaceRules:(e,t,r,s)=>{if(R.frames.shouldStopRequestProcess(e))return null;const i=R.requestFilter.findWhiteListRule(t,r,R.RequestTypes.DOCUMENT);return i&&i.isContent()?null:R.requestFilter.getReplaceRules(t,r,s)},processRequestResponse:function(e,t,r,s){s===R.RequestTypes.DOCUMENT&&(s=R.frames.getFrameDomain(e),i(e)&&R.hitStats.addDomainView(s))},postProcessRequest:l,recordRuleHit:function(e,t,r){t&&!R.utils.filters.isUserFilterRule(t)&&!R.utils.filters.isWhiteListFilterRule(t)&&i(e)&&(e=R.frames.getFrameDomain(e),R.hitStats.addRuleHit(e,t.ruleText,t.filterId,r))},onRequestBlocked:c,isCollectingCosmeticRulesHits:e=>!R.utils.browser.isEdgeBrowser()&&(i(e)||R.filteringLog.isOpen()),removeParamsFromUrl:(e,t)=>{if(!(t&&["GET","OPTIONS","HEAD"].includes(t.toUpperCase())))return null;var r=R.requestContextStorage.get(e);if(!r)return null;var{tab:s,requestUrl:i,referrerUrl:t,requestType:e}=r;if(R.frames.shouldStopRequestProcess(s))return null;const l=R.requestFilter.findWhiteListRule(i,t,R.RequestTypes.DOCUMENT);if(l&&l.isRemoveparamRule())return null;const u=R.requestFilter.getRemoveparamRules(i,t,e);if(!(u&&0<u.length))return null;let n=i,o=i;const c=[];return u.forEach(e=>{e.whiteListRule||(o=e.getRemoveparam().apply(n),o!==n&&c.push(e),n=o)}),o===i?null:(R.filteringLog.bindRemoveparamRulesToHttpRequestEvent(s,c,r.eventId),o)}}}(adguard);