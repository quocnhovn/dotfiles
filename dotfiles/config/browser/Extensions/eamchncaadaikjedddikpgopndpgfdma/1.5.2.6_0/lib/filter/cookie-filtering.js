adguard.cookieFiltering=function(x){"use strict";const b=new Map,v=(e,t,r,o,i,n)=>{let l=b.get(e);l||(l=[],b.set(e,l)),l.push({remove:n,cookie:{name:t,url:r,thirdParty:o},rules:i})},C=(t,r,o,i,n,l,s)=>{for(let e=0;e<l.length;e+=1)x.filteringLog.addCookieEvent(t,r,o,i,x.RequestTypes.COOKIE,l[e],s,n)},u=(r,o)=>new Promise(t=>{browser.cookies.remove({url:o,name:r},()=>{var e=browser.runtime.lastError;e&&x.console.error("Error remove cookie {0} - {1}: {2}",r,o,e),t()})}),m=(r,o)=>{const e={url:o,name:r.name,value:r.value,domain:r.domain,path:r.path,secure:r.secure,httpOnly:r.httpOnly,sameSite:r.sameSite,expirationDate:r.expirationDate};return r.hostOnly&&delete e.domain,new Promise(t=>{browser.cookies.set(e,()=>{var e=browser.runtime.lastError;e&&x.console.error("Error update cookie {0} - {1}: {2}",r.name,o,e),t()})})},h=(e,r)=>new Promise(t=>{browser.cookies.getAll({name:e,url:r},e=>{t(e||[])})}),l=e=>{e=e.getCookieOption();return!!e.sameSite||"number"==typeof e.maxAge&&0<e.maxAge},R=(t,r)=>{if(r&&0<r.length)for(let e=0;e<r.length;e+=1){const o=r[e],i=o.getCookieOption();if(i.matches(t)&&!l(o))return o}return null},y=(t,r)=>{let o=null;if(r&&0<r.length){for(let e=0;e<r.length;e+=1){const i=r[e],n=i.getCookieOption();if(n.matches(t)){if(!l(i))return null;null===o&&(o=[]),o.push(i)}}return o}return null},a=(r,o)=>{if(!o||0===o.length)return null;const i=[];for(let t=0;t<o.length;t+=1){const s=o[t];var n=s.getCookieOption();let e=!1;var l=n.sameSite;l&&r.sameSite!==l&&(r.sameSite=l,e=!0),"number"==typeof n.maxAge&&((e,t)=>{var r=Date.now()/1e3;let o=null;e.maxAge?o=r+e.maxAge:e.expires&&(o=e.expires.getTime()/1e3);r+=t;return(null===o||o>r)&&(e.expires?e.expires=new Date(1e3*r):e.maxAge=t,!0)})(r,n.maxAge)&&(e=!0),e&&i.push(s)}return i},S=(e,t,r,o,i,n)=>{var l=t.name,s=t.value;return!!((n=a(t,n))&&0<n.length)&&(i.value=x.utils.cookie.serialize(t),C(e,l,s,r,o,n,!0),!0)},c=(r,o)=>{const i=[];for(let t=0;t<o.length;t+=1){const s=o[t];var n=s.getCookieOption();let e=!1;var l=n.sameSite;l&&r.sameSite!==l&&(r.sameSite=l,e=!0),"number"==typeof n.maxAge&&((e,t)=>{let r=null;e.expirationDate&&(r=e.expirationDate);t=Date.now()/1e3+t;return(null===r||r>t)&&(e.expirationDate=t,!0)})(r,n.maxAge)&&(e=!0),e&&i.push(s)}return i};return{filterRequestHeaders:function(e,t){if(!browser.cookies)return!1;var r=x.requestContextStorage.get(e);if(!r)return!1;var o=r.tab||{},i=r.requestUrl||"",n=r.originUrl||r.referrerUrl,r=r.requestType||x.RequestTypes.DOCUMENT;const l=x.utils.browser.findHeaderByName(t,"Cookie"),s=x.utils.cookie.parseCookie(l?l.value:null);if(!s)return!1;var a=n&&x.utils.url.isThirdPartyRequest(i,n),u=x.webRequestService.getCookieRules(o,i,n,r),g=x.stealthService.getCookieRules(i,n,r);if(!(u&&0!==u.length||g&&0!==g.length))return!1;let m=!1,h=s.length;for(;--h;){var c=s[h].name,p=R(c,u);p&&(p.whiteListRule||(s.splice(h,1),m=!0),v(e,c,i,a,[p],!0));var f=y(c,u);f&&0<f.length&&v(e,c,i,a,f,!1),!!!(p&&!p.whiteListRule||f&&0<f.length)&&g&&0<g.length&&v(e,c,i,a,g,!1)}return m&&(l.value=s.map(e=>e.name+"="+e.value).join("; ")),m},filterResponseHeaders:function(e,t){if(!browser.cookies)return!1;var r=x.requestContextStorage.get(e);if(!r)return!1;var o,i,n,l,s,a,u,g=r.tab||{},m=r.requestUrl||"",h=r.originUrl||r.referrerUrl,c=r.requestType||x.RequestTypes.DOCUMENT,p=x.utils.url.getHost(m);const f=[];let v=!1,d=t.length;for(;0<d;){--d;const k=t[d];if(k.name&&"set-cookie"===k.name.toLowerCase()){const w=x.utils.cookie.parseSetCookie(k.value);w&&(o=w.name,i=w.value,n=w.domain||p,u=((e,t)=>{let r=t;return"."===r[0]&&(r=r.substring(1)),(e.secure?"https":"http")+"://"+r+(e.path||"/")})(w,n),l=h&&x.utils.url.isThirdPartyRequest(u,h),a=x.webRequestService.getCookieRules(g,u,h,c),(s=R(o,a))&&(s.whiteListRule||(delete w.expires,w.maxAge=0,k.value=x.utils.cookie.serialize(w),v=!0),f.push(o),C(g,o,i,n,l,[s],!1)),a=y(o,a),S(g,w,n,l,k,a)&&(v=!0,f.push(o)),s&&!s.whiteListRule||a&&0<a.length||(u=x.stealthService.getCookieRules(u,h,c),S(g,w,n,l,k,u)&&(v=!0,f.push(o))))}}return((t,r)=>{const o=b.get(t);if(o){let e=o.length;for(;--e;){var i=o[e].cookie;0<=r.indexOf(i.name)&&o.splice(e,1)}0===o.length&&b.delete(t)}})(e,f),v},modifyCookies:e=>{if(!browser.cookies)return!1;var t=x.requestContextStorage.get(e);if(!t)return!1;var r=t.tab||{};if(x.frames.shouldStopRequestProcess(r))return x.console.debug("Tab is whitelisted or protection is disabled"),b.delete(e),!1;var o=b.get(e);if(o&&0!==o.length){const s=[];for(let t=0;t<o.length;t+=1){var i=o[t],n=i.cookie||{},l=i.rules||[];let e;e=i.remove?((o,i,n,l,s,a)=>h(i,n).then(e=>{const t=[];var r;return 0<e.length&&(r=e[0],s.whiteListRule||(e=u(i,n),t.push(e)),a(o,r.name,r.value,r.domain,l,[s],!1)),Promise.all(t)}))(r,n.name,n.url,n.thirdParty,l[0],C):((l,e,s,a,u,g)=>h(e,s).then(t=>{const r=[];for(let e=0;e<t.length;e+=1){var o,i=t[e],n=c(i,u);n&&0<n.length&&(o=m(i,s),r.push(o),g(l,i.name,i.value,i.domain,a,n,!0))}return Promise.all(r)}))(r,n.name,n.url,n.thirdParty,l,C),s.push(e)}Promise.all(s).then(()=>{b.delete(e)})}}}}(adguard);