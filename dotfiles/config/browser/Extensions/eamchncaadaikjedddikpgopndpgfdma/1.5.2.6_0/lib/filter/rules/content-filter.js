!function(n,t){"use strict";function i(){this.map=Object.create(null),this.size=0,this.put=function(t,e){var i=this.map[t];i||(this.map[t]=i=[],this.size++),i.push(e)},this.remove=function(t,e){var i=this.map[t];i&&(n.utils.collections.removeRule(i,e),0===i.length&&(delete this.map[t],this.size--))},this.get=function(t){return this.map[t]},this.clear=function(){this.map=Object.create(null)},this.isEmpty=function(){return 0===this.size}}function e(t){if(this.contentRules=[],this.exceptionRulesMap=new i,this.dirty=!1,t)for(var e=0;e<t.length;e++)this.addRule(t[e])}e.prototype={addRule:function(t){t.tagName&&(t.whiteListRule?this.exceptionRulesMap.put(t.elementsFilter,t):this.contentRules.push(t),this.dirty=!0)},removeRule:function(t){n.utils.collections.removeRule(this.contentRules,t),this.exceptionRulesMap.remove(t.elementsFilter,t),this.rollbackExceptionRule(t),this.dirty=!0},getRulesForDomain:function(t){this.dirty&&this.rebuild();for(var e=null,i=0;i<this.contentRules.length;i++){var n=this.contentRules[i];n.isPermitted(t)&&(e=null===e?[]:e).push(n)}return e},getMatchedElementsForRules:function(t,e){if(!e||0===e.length)return null;for(var i=null,n=0;n<e.length;n++){var s=e[n].getMatchedElements(t);s&&0<s.length&&(i=(i=null===i?[]:i).concat(s))}return i},getMatchedElements:function(t,e){this.dirty&&this.rebuild();e=this.getRulesForDomain(e);return e?this.getMatchedElementsForRules(t,e):null},rebuild:function(){if(this.dirty){if(!this.exceptionRulesMap.isEmpty())for(var t=0;t<this.contentRules.length;t++)this.applyExceptionRules(this.contentRules[t]);this.dirty=!1}},applyExceptionRules:function(t){var e=this.exceptionRulesMap.get(t.elementsFilter);if(e)for(var i=0;i<e.length;i++){var n=e[i];this.applyExceptionRule(t,n)}},applyExceptionRule:function(t,e){t.elementsFilter===e.elementsFilter&&t.addRestrictedDomains(e.getPermittedDomains())},rollbackExceptionRule:function(t){if(t.whiteListRule)for(var e=0;e<this.contentRules.length;e++){var i=this.contentRules[e];i.elementsFilter===t.elementsFilter&&i.removeRestrictedDomains(t.getPermittedDomains())}}},t.ContentFilter=e}(adguard,adguard.rules);