adguard.antiBannerService=function(d){const r={filterId:d.utils.filters.USER_FILTER_ID};let i=new d.RequestFilter,n=0,a=!1,s=!1,u=d.settings.getFiltersUpdatePeriod();function c(e){return 0<=R.indexOf(e.event)}const t=3e5,l=6e4,f=1e3,o=1e3,E=[d.listeners.UPDATE_FILTER_RULES,d.listeners.FILTER_ENABLE_DISABLE,d.listeners.FILTER_GROUP_ENABLE_DISABLE],g=e=>0<=E.indexOf(e.event),R=[d.listeners.UPDATE_FILTER_RULES,d.listeners.ADD_RULES,d.listeners.REMOVE_RULE];let p=!1;function I(s,n){function r(){!function(){var t=d.filtersState.getFiltersVersion(),s=d.filtersState.getFiltersState(),n=d.subscriptions.getFilters();for(let e=0;e<n.length;e+=1){const l=n[e];var r=l["filterId"],i=t[r],r=s[r];i&&(l.version=i.version,l.lastCheckTime=i.lastCheckTime,l.lastUpdateTime=i.lastUpdateTime,i.expires&&(l.expires=i.expires)),r&&(l.enabled=r.enabled,l.installed=r.installed,l.loaded=r.loaded)}}(),function(){var t=d.filtersState.getGroupsState(),s=d.subscriptions.getGroups();for(let e=0;e<s.length;e+=1){const r=s[e];var n=r["groupId"],n=t[n];n&&(r.enabled=n.enabled)}}(),S(()=>{b(),n()})}function t(e){var t;!function(){const t=d.utils.concurrent.debounce(F,o);d.settings.onUpdated.addListener(e=>{e!==d.settings.USE_OPTIMIZED_FILTERS?(e===d.settings.DISABLE_COLLECT_HITS&&(i.cssFilter.dirty=!0),e===d.settings.FILTERS_UPDATE_PERIOD&&U()):t()})}(),e.isFirstRun?(b(),"function"==typeof s.onInstall?s.onInstall(n):n()):e.isUpdate?(d.applicationUpdateService.onUpdate(e,r),t=e,setTimeout(()=>{d.listeners.notifyListeners(d.listeners.APPLICATION_UPDATED,t)},l)):r(),U(e.isFirstRun)}d.applicationUpdateService.getRunInfo(async e=>{await d.subscriptions.init(),t(e)})}function e(){return i}function F(e,t){!function(){var t=d.subscriptions.getFilters();for(let e=0;e<t.length;e+=1){const s=t[e];s.version="0.0.0.0"}}(),m(!0,e,t)}const L=e=>{return e=Number.parseInt(e,10),1e3*(e=Number.isNaN(e)||e<3600?3600:e)};function _(t,e){const s=[],n=[];var r,i=e||d.subscriptions.getFilters();for(let e=0;e<i.length;e+=1){var l=i[e],o=d.subscriptions.getGroup(l.groupId);l.installed&&l.enabled&&o.enabled&&(t||(r=void 0,r=(o=l).lastCheckTime,o=o.expires,!r||(o=L(o),u===d.settings.DEFAULT_FILTERS_UPDATE_PERIOD?r+o<=Date.now():r+u<=Date.now())))&&(l.customUrl?n:s).push(l.filterId)}return{filterIds:s,customFilterIds:n}}const m=(e,r,i,t)=>{var s=()=>{};if(r=r||s,i=i||s,e||a){d.console.info("Start checking filters updates");e=_(e,t),t=e.filterIds;const o=e.customFilterIds;e=t.length+o.length;if(0===e)return r([]),void d.console.info("There is no filters to update");d.console.info("Checking updates for {0} filters",e);const u=e=>{!function(e,t){e=e.map(n=>new Promise((t,s)=>{A(n,!0,e=>e?t(n.filterId):s())}));Promise.all(e).then(e=>{t(!0,e)}).catch(()=>{t(!1)})}(e,(e,t)=>{if(e){const n=t.map(d.subscriptions.getFilter).filter(e=>e);t=o,s=e=>{r(n.concat(e))},0!==t.length?(t=t.map(e=>new Promise(t=>{const s=d.subscriptions.getFilter(e);d.subscriptions.updateCustomFilter(s.customUrl,{},e=>e?t(s):t())})),Promise.all(t).then(e=>{const t=e.filter(e=>e);0<t.length&&(e=t.map(e=>e.filterId).join(", "),d.console.info("Updated custom filters with ids: "+e)),s(t)})):s([])}else i();var s})};var n,l;l=(e,t)=>{if(e){const n=[];for(let e=0;e<t.length;e+=1){var s=t[e];const r=d.subscriptions.getFilter(s.filterId);r&&s.version&&d.utils.browser.isGreaterVersion(s.version,r.version)?(d.console.info(`Updating filter ${r.filterId} to version `+s.version),n.push(s)):r.lastCheckTime=Date.now()}u(n)}else i()},0!==(n=t).length?d.backend.loadFiltersMetadata(n,e=>{d.console.debug("Retrieved response from server for {0} filters, result: {1} metadata",n.length,e.length),l(!0,e)},(e,t)=>{d.console.error("Error retrieved response from server for filters {0}, cause: {1} {2}",n,e.statusText,t||""),l(!1)}):l(!0,[])}};function T(u,e){const t=(new Date).getTime();var s=d.requestFilter.isReady();d.console.info("Starting request filter initialization. Async={0}",s);const o=new d.RequestFilter;0===n&&(n=(new Date).getTime(),d.listeners.notifyListeners(d.listeners.APPLICATION_INITIALIZED));const a=Object.create(null);function c(){i=o,e&&"function"==typeof e&&e(),d.listeners.notifyListeners(d.listeners.REQUEST_FILTER_UPDATED,v()),d.console.info("Finished request filter initialization in {0} ms. Rules count: {1}",(new Date).getTime()-t,o.rulesCount),function(e){var t=Object.keys(e);if(0===t.length)return 1;var s=d.utils.filters.USER_FILTER_ID;if(1===t.length&&t[0]==s){s=e[s];if(!s||0===s.length)return 1}}(u)||(0!==o.rulesCount||p?0<o.rulesCount&&p&&(d.console.info("Filters reloaded, deleting reloadRules flag"),p=!1):(d.console.info("No rules have been found - checking filter updates"),F(),p=!0))}const l=function(t,s,n,r){if(s){var i=d.subscriptions.isTrustedFilter(t);for(let e=n;e<s.length&&e<r;e+=1){var l=s[e];l in a||(a[l]=!0,null!==(l=d.rules.builder.createRule(l,t,i))&&o.addRule(l))}}},f=(t,s,n,r,i)=>new Promise(e=>{i.then(()=>{setTimeout(()=>{l(t,s,n,r),e()},1)})});(s?function(){var t,s=Promise.resolve();let n=null;const r=[];for(t in u)if(t-=0,t!==d.utils.filters.USER_FILTER_ID){var i=u[t];for(let e=0;e<i.length;e+=1e3)n=f(t,i,e,e+1e3,n||s),r.push(n)}var e=d.utils.filters.USER_FILTER_ID,l=u[e],o=l.length;n=f(e,l,0,o,n||s),r.push(n),Promise.all(r).then(()=>{c()})}:function(){for(var e in u){var t;e-=0,e!=d.utils.filters.USER_FILTER_ID&&(t=u[e],l(e,t,0,t.length))}var s=u[d.utils.filters.USER_FILTER_ID];l(d.utils.filters.USER_FILTER_ID,s,0,s.length),c()})()}function S(e){if(!1!==a){const t=(new Date).getTime();d.console.info("Starting loading filter rules from the storage");const i=Object.create(null),l=function(){d.console.info("Finished loading filter rules from the storage in {0} ms",(new Date).getTime()-t),T(i,e)},o=(s,n,e)=>new Promise(t=>{d.rulesStorage.read(s,e=>{e&&(n[s]=e),t()})});!function(){const t=[];var s=d.subscriptions.getFilters();for(let e=0;e<s.length;e+=1){var n=s[e],r=d.subscriptions.getGroup(n.groupId);n.enabled&&r.enabled&&t.push(o(n.filterId,i))}t.push(o(d.utils.filters.USER_FILTER_ID,i)),Promise.all(t).then(l)}()}else"function"==typeof e&&e()}var v=function(){let e=0;return i&&(e=i.rulesCount),{rulesCount:e}};function b(){let o=[],u=null;function l(){const t=o.slice(0);o=[],u=null;var e,s=t.some(g);const n=Object.create(null);for(let e=0;e<t.length;e+=1){var r=t[e];r.filter&&(r.filter.filterId in n||(n[r.filter.filterId]=[]),n[r.filter.filterId].push(r))}const i=[];for(const l in n)n[l].some(c)&&(e=function(l,o){const e=new d.utils.Promise;return d.rulesStorage.read(l,t=>{for(let e=0;e<o.length;e+=1){t=t||[];var s=o[e],n=s.event,r=s.rules;switch(n){case d.listeners.ADD_RULES:t=t.concat(r),d.console.debug("Add {0} rules to filter {1}",r.length,l);break;case d.listeners.REMOVE_RULE:var i=r[0];d.utils.collections.removeAll(t,i),d.console.debug("Remove {0} rule from filter {1}",i,l);break;case d.listeners.UPDATE_FILTER_RULES:d.console.debug("Update filter {0} rules count to {1}",l,(t=r).length)}}d.console.debug("Save {0} rules to filter {1}",t.length,l),d.rulesStorage.write(l,t,()=>{e.resolve(),l===d.utils.filters.USER_FILTER_ID&&d.listeners.notifyListeners(d.listeners.UPDATE_USER_FILTER_RULES,v())})}),e}(l,n[l]),i.push(e));s?d.utils.Promise.all(i).then(S):d.listeners.notifyListeners(d.listeners.REQUEST_FILTER_UPDATED,v())}d.listeners.addListener((e,t,s)=>{switch(e){case d.listeners.ADD_RULES:case d.listeners.REMOVE_RULE:case d.listeners.UPDATE_FILTER_RULES:case d.listeners.FILTER_ENABLE_DISABLE:n=e,r=t,i=s,o.push({event:n,filter:r,rules:i}),null!==u&&clearTimeout(u),u=setTimeout(l,f)}var n,r,i}),d.listeners.addListener((e,t)=>{e===d.listeners.FILTER_GROUP_ENABLE_DISABLE&&(e=e,t=t,o.push({event:e,group:t}),null!==u&&clearTimeout(u),u=setTimeout(l,f))})}let h;function U(e){u=d.settings.getFiltersUpdatePeriod(),e&&setTimeout(m,t,e),function e(){h&&clearTimeout(h),0!==u&&(h=setTimeout(()=>{try{m()}catch(e){d.console.error("Error update filters, cause {0}",e)}e()},18e5))}()}function D(e){var t=d.subscriptions.getFilter(e);if(!t)throw new Error(`Filter with id: ${e} not found`);return t}function A(t,s,n){const r=D(t.filterId);r._isDownloading=!0,d.listeners.notifyListeners(d.listeners.START_DOWNLOAD_FILTER,r);d.backend.loadFilterRules(r.filterId,s,d.settings.isUseOptimizedFiltersEnabled()).then(e=>{d.console.info("Retrieved response from server for filter {0}, rules count: {1}",r.filterId,e.length),delete r._isDownloading,r.version=t.version,r.lastUpdateTime=t.timeUpdated,r.lastCheckTime=s?Date.now():t.timeUpdated,r.loaded=!0,r.expires=t.expires,d.listeners.notifyListeners(d.listeners.SUCCESS_DOWNLOAD_FILTER,r),d.listeners.notifyListeners(d.listeners.UPDATE_FILTER_RULES,r,e),n(!0)},e=>{d.console.error("Error retrieving response from the server for filter {0}, cause: {1}:",r.filterId,e||""),delete r._isDownloading,d.listeners.notifyListeners(d.listeners.ERROR_DOWNLOAD_FILTER,r),n(!1)})}return{start:function(e,t){if(!0!==a){if(a=!0,!s)return I(e,t),void(s=!0);S(t)}else t()},stop:function(){a=!1,i=new d.RequestFilter,d.listeners.notifyListeners(d.listeners.REQUEST_FILTER_UPDATED,v())},isInitialized:function(){return s},addAntiBannerFilter:(e,t)=>{const s=D(e);s.installed?t(!0):(e=e=>{e&&(s.installed=!0,d.listeners.notifyListeners(d.listeners.FILTER_ADD_REMOVE,s)),t(e)},s.loaded?e(!0):A(s,!1,e))},getRequestFilter:e,getRequestFilterInitTime:function(){return n},addUserFilterRules:function(t){const s=[];for(let e=0;e<t.length;e+=1){var n=d.rules.builder.createRule(t[e],d.utils.filters.USER_FILTER_ID);null!==n&&s.push(n)}return i.addRules(s),d.listeners.notifyListeners(d.listeners.ADD_RULES,r,t),d.listeners.notifyListeners(d.listeners.UPDATE_USER_FILTER_RULES,v()),s},updateUserFilterRules:function(e){d.listeners.notifyListeners(d.listeners.UPDATE_FILTER_RULES,r,e),d.listeners.notifyListeners(d.listeners.UPDATE_USER_FILTER_RULES,v())},removeUserFilterRule:function(e){var t=d.rules.builder.createRule(e,d.utils.filters.USER_FILTER_ID);null!==t&&i.removeRule(t),d.listeners.notifyListeners(d.listeners.REMOVE_RULE,r,[e])},getRequestFilterInfo:v,checkAntiBannerFiltersUpdate:m}}(adguard),adguard.requestFilter=function(){"use strict";const t=adguard["antiBannerService"];function r(){return t.getRequestFilter()}return{isReady:function(){return 0<t.getRequestFilterInitTime()},shouldCollapseAllElements:function(){var e=t.getRequestFilterInitTime();return 0<e&&e+5e3>(new Date).getTime()},getRules:function(){return r().getRules()},findRuleForRequest:function(e,t,s,n){return r().findRuleForRequest(e,t,s,n)},findWhiteListRule:function(e,t,s){return r().findWhiteListRule(e,t,s)},getSelectorsForUrl:function(e,t){return r().getSelectorsForUrl(e,t)},getInjectedSelectorsForUrl:function(e,t){return r().getInjectedSelectorsForUrl(e,t)},getScriptsForUrl:function(e){return r().getScriptsForUrl(e)},getScriptsStringForUrl:function(e,t){return r().getScriptsStringForUrl(e,t)},getContentRulesForUrl:function(e){return r().getContentRulesForUrl(e)},getMatchedElementsForContentRules:function(e,t){return r().getMatchedElementsForContentRules(e,t)},getCspRules:function(e,t,s){return r().findCspRules(e,t,s)},getCookieRules:function(e,t,s){return r().findCookieRules(e,t,s)},getReplaceRules:function(e,t,s){return r().findReplaceRules(e,t,s)},findStealthWhiteListRule:function(e,t,s){return r().findStealthWhiteListRule(e,t,s)},getRequestFilterInfo:function(){return t.getRequestFilterInfo()},getRemoveparamRules:function(e,t,s){return r().findRemoveparamRules(e,t,s)}}}(),adguard.filtersState=function(s){function n(){let e=Object.create(null);try{var t=s.localStorage.getItem(a);t&&(e=JSON.parse(t))}catch(e){s.console.error("Error retrieve filters version info, cause {0}",e)}return e}function r(){let e=Object.create(null);try{var t=s.localStorage.getItem(u);t&&(e=JSON.parse(t))}catch(e){s.console.error("Error retrieve filters state info, cause {0}",e)}return e}function i(){let e=Object.create(null);try{var t=s.localStorage.getItem(c);t&&(e=JSON.parse(t))}catch(e){s.console.error("Error retrieve groups state info, cause {0}",e)}return e}function l(e){const t=n();t[e.filterId]={version:e.version,lastCheckTime:e.lastCheckTime,lastUpdateTime:e.lastUpdateTime,expires:e.expires},s.localStorage.setItem(a,JSON.stringify(t))}function o(e){const t=r();t[e.filterId]={loaded:e.loaded,enabled:e.enabled,installed:e.installed},s.localStorage.setItem(u,JSON.stringify(t))}const u="filters-state",a="filters-version",c="groups-state";return s.listeners.addListener((e,t)=>{switch(e){case s.listeners.SUCCESS_DOWNLOAD_FILTER:o(t),l(t);break;case s.listeners.FILTER_ADD_REMOVE:case s.listeners.FILTER_ENABLE_DISABLE:o(t);break;case s.listeners.FILTER_GROUP_ENABLE_DISABLE:!function(e){const t=i();t[e.groupId]={enabled:e.enabled},s.localStorage.setItem(c,JSON.stringify(t))}(t)}}),{getFiltersVersion:n,getFiltersState:r,getGroupsState:i,updateFilterVersion:l,updateFilterState:o,removeFilter:e=>{const t=r();delete t[e],s.localStorage.setItem(u,JSON.stringify(t))}}}(adguard),adguard.filters=function(l){"use strict";const o=l["antiBannerService"];const u=function(e){const t=l.subscriptions.getGroup(e);t&&!t.enabled&&(t.enabled=!0,l.listeners.notifyListeners(l.listeners.FILTER_GROUP_ENABLE_DISABLE,t))};return{start:function(e,t){o.start(e,t)},stop:function(e){o.stop(),e()},isInitialized:function(){return o.isInitialized()},offerFilters:e=>{const t=[];l.prefs.mobile&&t.push(l.utils.filters.MOBILE_ADS_FILTER_ID),t.concat(l.subscriptions.getLangSuitableFilters()),e(t)},getEnabledFilters:()=>l.subscriptions.getFilters().filter(e=>e.installed&&e.enabled),isFilterEnabled:function(e){e=l.subscriptions.getFilter(e);return e&&e.enabled},isFilterInstalled:function(e){e=l.subscriptions.getFilter(e);return e&&e.installed},checkFiltersUpdates:(e,t,s)=>{s?0<(s=s.filter(e=>!e.lastCheckTime||3e5<Date.now()-e.lastCheckTime)).length&&o.checkAntiBannerFiltersUpdate(!0,e,t,s):o.checkAntiBannerFiltersUpdate(!0,e,t)},addAndEnableFilters:(e,s,n)=>{s=s||function(){};const r=[];if(e&&0!==e.length){e=l.utils.collections.removeDuplicates(e.slice(0));const i=()=>{if(0===e.length)s(r);else{const t=e.shift();o.addAntiBannerFilter(t,e=>{e&&((e,t)=>{const s=l.subscriptions.getFilter(e);if(!s||s.enabled||!s.installed)return!1;s.enabled=!0;e=s.groupId,t=t&&t.forceGroupEnable;return l.subscriptions.groupHasEnabledStatus(e)&&!t||u(e),l.listeners.notifyListeners(l.listeners.FILTER_ENABLE_DISABLE,s),!0})(t,n)&&(e=l.subscriptions.getFilter(t),r.push(e)),i()})}};i()}else s(r)},disableFilters:function(t){t=l.utils.collections.removeDuplicates(t.slice(0));for(let e=0;e<t.length;e+=1){var s=t[e];const n=l.subscriptions.getFilter(s);n&&n.enabled&&n.installed&&(n.enabled=!1,l.listeners.notifyListeners(l.listeners.FILTER_ENABLE_DISABLE,n))}},uninstallFilters:function(t){t=l.utils.collections.removeDuplicates(t.slice(0));for(let e=0;e<t.length;e+=1){var s=t[e];const n=l.subscriptions.getFilter(s);n&&n.installed&&(l.console.debug("Uninstall filter {0}",n.filterId),n.enabled=!1,n.installed=!1,l.listeners.notifyListeners(l.listeners.FILTER_ENABLE_DISABLE,n),l.listeners.notifyListeners(l.listeners.FILTER_ADD_REMOVE,n))}},removeFilter:function(e){const t=l.subscriptions.getFilter(e);t&&!t.removed&&(t.customUrl?(l.console.debug("Remove filter {0}",t.filterId),t.enabled=!1,t.installed=!1,t.removed=!0,l.listeners.notifyListeners(l.listeners.FILTER_ENABLE_DISABLE,t),l.listeners.notifyListeners(l.listeners.FILTER_ADD_REMOVE,t)):l.console.error("Filter {0} is not custom and could not be removed",t.filterId))},enableGroup:u,disableGroup:function(e){const t=l.subscriptions.getGroup(e);t&&t.enabled&&(t.enabled=!1,l.listeners.notifyListeners(l.listeners.FILTER_GROUP_ENABLE_DISABLE,t))},loadCustomFilter:function(e,t,s,n){l.console.info("Downloading custom filter from {0}",e),e?l.subscriptions.updateCustomFilter(e,t,e=>{if(e){l.console.info("Custom filter downloaded");const t=l.subscriptions.getFilter(e);delete t.removed,s(t)}else n()}):n()},loadCustomFilterInfo:(e,t,s,n)=>{l.console.info("Downloading custom filter info from "+e),e?l.subscriptions.getCustomFilterInfo(e,t,(e={})=>{var{error:t,filter:e}=e;if(e)return l.console.info("Custom filter data downloaded"),void s(e);n(t)}):n()},getEnabledFiltersFromEnabledGroups:()=>{const e=l.subscriptions.getFilters(),t=l.subscriptions.getGroups().filter(e=>e.enabled).map(e=>e.groupId);return e.filter(e=>e.enabled&&t.includes(e.groupId))}}}(adguard);