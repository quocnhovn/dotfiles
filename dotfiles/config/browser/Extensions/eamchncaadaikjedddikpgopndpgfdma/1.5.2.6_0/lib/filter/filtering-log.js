adguard.filteringLog=function(l){"use strict";const n=1e3,i=l.BACKGROUND_TAB_ID;var e={tabId:i,title:l.i18n.getMessage("background_tab_title")};const u=Object.create(null);let f=0;function t(e){const t=u[e.tabId]||Object.create(null);return t.tabId=e.tabId,t.title=e.title,t.isExtensionTab=e.url&&0===e.url.indexOf(l.app.getExtensionUrl()),u[e.tabId]=t,t}function a(e){e.tabId===i||e.synthetic||(e=t(e))&&l.listeners.notifyListeners(l.listeners.TAB_ADDED,e)}function o(e){var t;e!==i&&((t=u[e])&&l.listeners.notifyListeners(l.listeners.TAB_CLOSE,t),delete u[e])}function c(e){e.tabId===i||(e=t(e))&&l.listeners.notifyListeners(l.listeners.TAB_UPDATE,e)}l.prefs.features.hasBackgroundTab&&(u[i]=e);const d=(e,t)=>{var n;e&&t&&(e.filterId=t.filterId,e.ruleText=t.ruleText,t.isImportant&&(e.isImportant=t.isImportant),t.convertedRuleText&&(e.convertedRuleText=t.convertedRuleText),t.documentLevelRule&&(e.documentLevelRule=t.documentLevelRule),t instanceof l.rules.ContentFilterRule?e.contentRule=!0:t instanceof l.rules.CssFilterRule?e.cssRule=!0:(n=t)instanceof l.rules.ScriptFilterRule||n instanceof l.rules.ScriptletRule?e.scriptRule=!0:t instanceof l.rules.UrlFilterRule&&(e.whiteListRule=t.whiteListRule,e.cspRule=t.isCspRule(),e.cspDirective=t.cspDirective,e.cookieRule=!!t.getCookieOption()))};function v(e,t){e.requestRule={},d(e.requestRule,t)}function p(e,t){e.filteringEvents||(e.filteringEvents=[]),e.filteringEvents.push(t),e.filteringEvents.length>n&&e.filteringEvents.splice(1,1),l.listeners.notifyListeners(l.listeners.LOG_EVENT_ADDED,e,t)}function s(r){l.tabs.getAll(t=>{const n=Object.keys(u).map(e=>parseInt(e,10));for(let e=0;e<t.length;e++){var i=t[e];(u[i.tabId]?c:a)(i);i=n.indexOf(i.tabId);0<=i&&n.splice(i,1)}for(let e=0;e<n.length;e++)o(n[e]);if("function"==typeof r){const e=[];for(const s in u)e.push(u[s]);r(e)}})}return{synchronizeOpenTabs:s,init:()=>{s(),l.tabs.onCreated.addListener(a),l.tabs.onUpdated.addListener(c),l.tabs.onRemoved.addListener(e=>{o(e.tabId)})},getFilteringInfoByTabId:function(e){return u[e]},addHttpRequestEvent:function(e,t,n,i,s,r){0===f||(e=u[e.tabId])&&(n={eventId:r,requestUrl:t,requestDomain:l.utils.url.getDomainName(t),frameUrl:n,frameDomain:l.utils.url.getDomainName(n),requestType:i,requestThirdParty:l.utils.url.isThirdPartyRequest(t,n)},s&&v(n,s),p(e,n))},bindRuleToHttpRequestEvent:function(e,t,n){if(0!==f){var i=u[e.tabId];if(i){var s=i.filteringEvents;if(s)for(let e=s.length-1;0<=e;--e){var r=s[e];if(r.eventId===n){v(r,t),l.listeners.notifyListeners(l.listeners.LOG_EVENT_UPDATED,i,r);break}}}}},bindReplaceRulesToHttpRequestEvent:function(e,t,n){if(0!==f){var i=u[e.tabId];if(i){var s=i.filteringEvents;if(s)for(let e=s.length-1;0<=e;--e){var r=s[e];if(r.eventId===n){((n,e)=>{n.requestRule={},n.requestRule.replaceRule=!0,n.replaceRules=[],e.forEach(e=>{var t={};d(t,e),n.replaceRules.push(t)})})(r,t),l.listeners.notifyListeners(l.listeners.LOG_EVENT_UPDATED,i,r);break}}}}},addCosmeticEvent:function(e,t,n,i,s){var r;0!==f&&(!s||(r=u[e.tabId])&&(e=l.utils.url.getDomainName(n),i={element:"string"==typeof t?t:l.utils.strings.elementToString(t),frameUrl:n,frameDomain:e,requestType:i},s&&v(i,s),p(r,i)))},addCookieEvent:function(e,t,n,i,s,r,l,a){if(0!==f){e=u[e.tabId];if(e){const o={frameDomain:i,requestType:s,requestThirdParty:a,cookieName:t,cookieValue:n};r&&(v(o,r),o.requestRule.isModifyingCookieRule=l,r.stealthActions&&(o.stealthActions=r.stealthActions)),p(e,o)}}},addScriptInjectionEvent:(e,t,n,i)=>{0===f||!i||(e=u[e.tabId])&&(v(n={script:!0,requestUrl:t,frameUrl:t,frameDomain:l.utils.url.getDomainName(t),requestType:n},i),p(e,n))},bindStealthActionsToHttpRequestEvent:(e,t,n)=>{if(0!==f){var i=u[e.tabId];if(i){var s=i.filteringEvents;if(s)for(let e=s.length-1;0<=e;--e){const r=s[e];if(r.eventId===n){r.stealthActions=t,l.listeners.notifyListeners(l.listeners.LOG_EVENT_UPDATED,i,r);break}}}}},bindCspReportBlockedToHttpRequestEvent:(e,t,n)=>{if(0!==f){var i=u[e.tabId];if(i){var s=i.filteringEvents;if(s)for(let e=s.length-1;0<=e;--e){const r=s[e];if(r.eventId===n){r.cspReportBlocked=t,l.listeners.notifyListeners(l.listeners.LOG_EVENT_UPDATED,i,r);break}}}}},bindRemoveparamRulesToHttpRequestEvent:(e,t,n)=>{if(0!==f){var i=u[e.tabId];if(i){var s=i.filteringEvents;if(s)for(let e=s.length-1;0<=e;--e){var r=s[e];if(r.eventId===n){((n,e)=>{n.requestRule={},n.removeparamRules=[],e.forEach(e=>{var t={};d(t,e),n.removeparamRules.push(t)})})(r,t),l.listeners.notifyListeners(l.listeners.LOG_EVENT_UPDATED,i,r);break}}}}},clearEventsByTabId:function(e){const t=u[e];t&&(delete t.filteringEvents,l.listeners.notifyListeners(l.listeners.TAB_RESET,t))},isOpen:function(){return 0<f},onOpenFilteringLogPage:function(){f++},onCloseFilteringLogPage:function(){if(f=Math.max(f-1,0),0===f)for(const e in u){const t=u[e];delete t.filteringEvents}}}}(adguard);